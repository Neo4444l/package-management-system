# 🔐 权限管理系统实施指南

## 📌 系统概述

本指南将帮助您为包裹管理系统添加完整的权限管理功能，包括：

- ✅ 三级角色系统（管理员/经理/普通用户）
- ✅ 基于角色的权限控制
- ✅ 用户管理界面
- ✅ 操作日志记录
- ✅ 账号激活/停用功能

---

## 🎯 角色说明

### 1. 管理员 (admin)
**完全权限：**
- ✅ 查看/添加/编辑/删除包裹
- ✅ 查看/添加/删除库位
- ✅ 管理所有用户
- ✅ 修改用户角色
- ✅ 激活/停用账号
- ✅ 查看操作日志

### 2. 经理 (manager)
**大部分权限：**
- ✅ 查看/添加/编辑/删除包裹
- ✅ 查看/添加库位（不能删除）
- ❌ 不能管理用户
- ❌ 不能查看日志

### 3. 普通用户 (user)
**基本权限：**
- ✅ 查看/添加/编辑包裹（不能删除）
- ✅ 查看库位（不能添加/删除）
- ❌ 不能管理用户

---

## 📋 实施步骤

### 步骤1：执行数据库SQL脚本（10分钟）

#### 1.1 打开Supabase SQL编辑器

1. 访问 https://supabase.com
2. 登录并选择您的项目
3. 点击左侧 **"SQL Editor"**
4. 点击 **"New query"**

#### 1.2 执行权限管理SQL

1. 打开文件：`权限管理系统-完整SQL.sql`
2. 复制全部内容
3. 粘贴到SQL编辑器
4. 点击 **"Run"** 按钮
5. 等待执行完成（约10-20秒）

#### 1.3 验证执行结果

在SQL编辑器中运行：
```sql
SELECT * FROM profiles;
```

应该能看到profiles表已创建。

---

### 步骤2：设置第一个管理员（重要！）

#### 2.1 获取您的邮箱对应的用户ID

在Supabase SQL编辑器中运行：
```sql
SELECT id, email, role FROM profiles;
```

找到您的邮箱。

#### 2.2 将自己设为管理员

替换下面的邮箱为您的邮箱，然后执行：
```sql
UPDATE profiles 
SET role = 'admin' 
WHERE email = 'your_email@example.com';
```

#### 2.3 验证

再次查询：
```sql
SELECT email, role FROM profiles WHERE role = 'admin';
```

应该看到您的账号角色为 `admin`。

---

### 步骤3：更新前端代码（已完成）

以下文件已自动创建/更新：

✅ **已创建：**
- `src/components/UserManagement.jsx` - 用户管理界面
- `src/components/UserManagement.css` - 用户管理样式

✅ **已更新：**
- `src/App.jsx` - 添加角色获取和显示
- `src/App.css` - 添加角色徽章样式

---

### 步骤4：测试权限功能（15分钟）

#### 4.1 测试管理员权限

1. 启动开发服务器：`npm run dev`
2. 用管理员账号登录
3. 应该看到：
   - 右上角显示"管理员"徽章（红色）
   - 右上角有"👥 用户管理"按钮
4. 点击"用户管理"进入用户管理页面

#### 4.2 测试用户管理功能

在用户管理页面：

1. ✅ 查看所有用户列表
2. ✅ 查看用户统计（总数、激活数、各角色数）
3. ✅ 修改用户角色（下拉选择）
4. ✅ 激活/停用用户

#### 4.3 测试权限控制

1. 创建一个测试普通用户账号
2. 登录普通用户账号
3. 验证：
   - ❌ 看不到"用户管理"按钮
   - ❌ 访问 `/user-management` 显示"访问被拒绝"
   - ✅ 可以正常使用包裹管理功能

---

## 🎨 用户界面说明

### 顶部用户信息栏

登录后右上角显示：
```
👤 your@email.com [角色徽章] [👥 用户管理] [退出登录]
```

**角色徽章颜色：**
- 🔴 管理员 - 红色渐变
- 🟠 经理 - 橙色渐变
- 🔵 普通用户 - 蓝色渐变

**用户管理按钮：**
- 只有管理员可见
- 绿色按钮
- 点击进入用户管理页面

### 用户管理页面

**页面结构：**
```
┌─────────────────────────────────────────┐
│ 👥 用户管理                              │
├─────────────────────────────────────────┤
│ [统计卡片]                               │
│ 总用户数 | 激活用户 | 管理员 | 经理       │
├─────────────────────────────────────────┤
│ [用户列表表格]                           │
│ 邮箱 | 姓名 | 角色 | 状态 | 操作         │
└─────────────────────────────────────────┘
```

**功能：**
- 查看用户详细信息
- 修改用户角色（下拉选择）
- 激活/停用用户（按钮切换）
- 自动统计数据

---

## 🔧 数据库结构

### profiles 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 用户ID（关联auth.users）|
| email | TEXT | 邮箱 |
| full_name | TEXT | 姓名 |
| role | TEXT | 角色（admin/manager/user）|
| department | TEXT | 部门 |
| is_active | BOOLEAN | 是否激活 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

### operation_logs 表（可选）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 日志ID |
| user_id | UUID | 操作用户ID |
| action | TEXT | 操作类型 |
| target_type | TEXT | 目标类型 |
| details | JSONB | 详细信息 |
| created_at | TIMESTAMPTZ | 操作时间 |

---

## 🛡️ 权限策略

### packages表权限

```
操作     | admin | manager | user
---------|-------|---------|------
查看     | ✅    | ✅      | ✅
添加     | ✅    | ✅      | ✅
编辑     | ✅    | ✅      | ✅
删除     | ✅    | ✅      | ❌
```

### locations表权限

```
操作     | admin | manager | user
---------|-------|---------|------
查看     | ✅    | ✅      | ✅
添加     | ✅    | ✅      | ❌
删除     | ✅    | ❌      | ❌
```

### profiles表权限

```
操作         | admin | manager | user
-------------|-------|---------|------
查看所有     | ✅    | ❌      | ❌
查看自己     | ✅    | ✅      | ✅
修改所有     | ✅    | ❌      | ❌
修改自己     | ✅    | ✅      | ✅（不含角色）
```

---

## 📱 使用场景

### 场景1：新员工入职

1. 新员工自己注册账号（默认为普通用户）
2. 管理员在用户管理页面：
   - 激活账号
   - 设置部门
   - 根据职位设置角色

### 场景2：员工升职

1. 管理员进入用户管理页面
2. 找到该员工
3. 修改角色（user → manager → admin）

### 场景3：员工离职

1. 管理员进入用户管理页面
2. 找到该员工
3. 点击"停用"按钮
4. 账号被停用，无法登录

### 场景4：临时权限

1. 管理员临时提升某用户权限
2. 完成任务后降回原权限

---

## ⚙️ 高级配置

### 自动分配角色

如果需要根据邮箱域名自动分配角色，修改触发器：

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, email, role)
  VALUES (
    new.id, 
    new.email,
    CASE 
      WHEN new.email LIKE '%@company.com' THEN 'manager'
      ELSE 'user'
    END
  );
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 添加操作日志

在关键操作中记录日志：

```javascript
const logOperation = async (action, targetType, details) => {
  const { data: { user } } = await supabase.auth.getUser()
  
  await supabase
    .from('operation_logs')
    .insert({
      user_id: user.id,
      user_email: user.email,
      action,
      target_type: targetType,
      details
    })
}

// 使用示例
await logOperation('delete_package', 'package', { 
  package_id: 'xxx',
  package_number: 'PKG001' 
})
```

---

## ✅ 测试检查清单

### 数据库层面
- [ ] profiles表已创建
- [ ] operation_logs表已创建
- [ ] 触发器正常工作
- [ ] 权限策略已设置
- [ ] 至少有一个管理员账号

### 前端界面
- [ ] 登录后显示角色徽章
- [ ] 管理员可见用户管理按钮
- [ ] 非管理员不可见用户管理按钮
- [ ] 用户管理页面正常显示
- [ ] 角色修改功能正常
- [ ] 账号激活/停用功能正常

### 权限控制
- [ ] 普通用户无法删除包裹
- [ ] 普通用户无法添加/删除库位
- [ ] 普通用户无法访问用户管理
- [ ] 经理可以删除包裹
- [ ] 经理无法删除库位
- [ ] 管理员拥有所有权限

---

## 🔍 故障排查

### 问题1：角色徽章不显示

**检查：**
```sql
SELECT id, email, role FROM profiles;
```

确认role字段有值。

**解决：**
```sql
UPDATE profiles SET role = 'user' WHERE role IS NULL;
```

### 问题2：用户管理页面空白

**检查：**
1. 浏览器控制台是否有错误
2. 当前用户是否为管理员
3. profiles表是否有权限策略

**解决：**
确保管理员可以查看所有用户：
```sql
CREATE POLICY "管理员可以查看所有资料"
  ON profiles FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );
```

### 问题3：普通用户可以删除包裹

**检查：**
packages表的DELETE策略。

**解决：**
重新执行`权限管理系统-完整SQL.sql`中的策略部分。

---

## 🚀 部署到Vercel

权限管理功能无需额外配置，跟随主应用一起部署即可：

```bash
git add .
git commit -m "添加权限管理系统"
git push
```

Vercel会自动重新部署。

---

## 📊 效果展示

### 登录后界面

```
┌────────────────────────────────────────────┐
│  [Logo] 包裹管理系统                        │
│                                            │
│              [主要功能区域]          👤 user@example.com │
│                                      [管理员] │
│                                      [👥 用户管理] │
│                                      [退出登录] │
└────────────────────────────────────────────┘
```

### 用户管理页面

```
┌─────────────────────────────────────────────┐
│ 👥 用户管理                                  │
│ 管理系统用户和权限                           │
├─────────────────────────────────────────────┤
│ [10]      [8]        [2]       [1]          │
│ 总用户数  激活用户   管理员    经理          │
├─────────────────────────────────────────────┤
│ 邮箱        | 角色 | 状态 | 操作             │
│ admin@xx.com| 管理员| 激活 | [▼] [停用]     │
│ user@xx.com | 用户  | 激活 | [▼] [停用]     │
└─────────────────────────────────────────────┘
```

---

## 💡 最佳实践

1. **至少设置2个管理员**
   - 防止唯一管理员账号出问题

2. **定期审查用户权限**
   - 每月检查一次
   - 移除离职员工账号

3. **记录重要操作**
   - 删除数据时记录日志
   - 权限变更时记录日志

4. **权限最小化原则**
   - 默认给最小权限
   - 需要时再提升

5. **测试环境隔离**
   - 生产环境和测试环境分开
   - 测试用户不能访问生产数据

---

## 🎉 完成！

现在您的系统拥有：
- ✅ 完整的角色权限管理
- ✅ 美观的用户管理界面
- ✅ 基于数据库的权限控制
- ✅ 灵活的角色分配

**享受您的企业级权限管理系统吧！** 🚀

---

## 📞 需要帮助？

如果遇到问题：
1. 查看本文档的"故障排查"部分
2. 检查Supabase控制台的日志
3. 查看浏览器控制台错误信息

