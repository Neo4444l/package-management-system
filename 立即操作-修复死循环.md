# ğŸš¨ ç«‹å³æ“ä½œ - ä¿®å¤åŸå¸‚åˆ‡æ¢æ­»å¾ªç¯

## âœ… ä»£ç å·²ä¿®å¤å®Œæˆï¼

å·²æ›´æ–°çš„æ–‡ä»¶ï¼š
1. âœ… `src/contexts/CityContext.jsx` - æ·»åŠ è¶…æ—¶ä¿æŠ¤å’Œé”™è¯¯æ¢å¤
2. âœ… `src/components/UserManagement.jsx` - ä¿®å¤åŸå¸‚é€‰é¡¹å¼•ç”¨
3. âœ… `src/components/CitySelector.jsx` - å·²ç¡®è®¤æ— é—®é¢˜

---

## ğŸ¯ ç«‹å³æ‰§è¡Œï¼ˆ5åˆ†é’Ÿå®Œæˆï¼‰

### ç¬¬ 1 æ­¥ï¼šæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ â±ï¸ 30ç§’

**Windows:**
```
1. æŒ‰ Ctrl + Shift + Delete
2. é€‰æ‹©"æ‰€æœ‰æ—¶é—´"
3. å‹¾é€‰æ‰€æœ‰é¡¹
4. ç‚¹å‡»"æ¸…é™¤æ•°æ®"
```

**Mac:**
```
1. æŒ‰ Cmd + Shift + Delete
2. é€‰æ‹©"æ‰€æœ‰æ—¶é—´"
3. å‹¾é€‰æ‰€æœ‰é¡¹
4. ç‚¹å‡»"æ¸…é™¤æ•°æ®"
```

**æˆ–è€…åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š**
```javascript
// æŒ‰ F12 æ‰“å¼€æ§åˆ¶å°ï¼Œç²˜è´´å¹¶å›è½¦ï¼š
localStorage.clear()
sessionStorage.clear()
document.cookie.split(";").forEach(c => {
  document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
})
location.reload()
```

---

### ç¬¬ 2 æ­¥ï¼šä¿®å¤æ•°æ®åº“ â±ï¸ 2åˆ†é’Ÿ

è®¿é—®ï¼šhttps://supabase.com â†’ ä½ çš„é¡¹ç›® â†’ SQL Editor

**å¤åˆ¶å¹¶æ‰§è¡Œä»¥ä¸‹å®Œæ•´è„šæœ¬ï¼š**

```sql
-- ==================== ç´§æ€¥ä¿®å¤è„šæœ¬ ====================

-- 1. æ£€æŸ¥å½“å‰çŠ¶æ€
SELECT 
  '=== ç”¨æˆ·åŸå¸‚æƒé™æ£€æŸ¥ ===' AS info,
  COUNT(*) AS total_users,
  COUNT(*) FILTER (WHERE cities IS NULL OR array_length(cities, 1) IS NULL) AS users_without_cities,
  COUNT(*) FILTER (WHERE role = 'super_admin') AS super_admins
FROM profiles;

-- 2. ä¿®å¤æ‰€æœ‰ç”¨æˆ·çš„åŸå¸‚æ•°æ®
DO $$
DECLARE
  fixed_count INTEGER := 0;
BEGIN
  -- Super Adminï¼šæ‰€æœ‰åŸå¸‚
  UPDATE profiles
  SET 
    cities = ARRAY['MIA', 'WPB', 'FTM', 'MCO', 'TPA'],
    current_city = COALESCE(current_city, 'MIA')
  WHERE role = 'super_admin';
  
  GET DIAGNOSTICS fixed_count = ROW_COUNT;
  RAISE NOTICE 'Super Admin ä¿®å¤: % äºº', fixed_count;

  -- å…¶ä»–ç”¨æˆ·ï¼šå¦‚æœåŸå¸‚ä¸ºç©ºï¼Œç»™ MIA
  UPDATE profiles
  SET 
    cities = ARRAY['MIA'],
    current_city = 'MIA'
  WHERE (cities IS NULL OR array_length(cities, 1) IS NULL)
    AND role != 'super_admin';
  
  GET DIAGNOSTICS fixed_count = ROW_COUNT;
  RAISE NOTICE 'æ™®é€šç”¨æˆ·ä¿®å¤: % äºº', fixed_count;

  -- ä¿®å¤ current_city ä¸åœ¨ cities ä¸­çš„æƒ…å†µ
  UPDATE profiles
  SET current_city = cities[1]
  WHERE current_city IS NULL 
    OR NOT (current_city = ANY(cities));
  
  GET DIAGNOSTICS fixed_count = ROW_COUNT;
  RAISE NOTICE 'Current city ä¿®å¤: % äºº', fixed_count;
END $$;

-- 3. ä¿®å¤åŒ…è£¹å’Œåº“ä½
UPDATE packages SET city = 'MIA' WHERE city IS NULL;
UPDATE locations SET city = 'MIA' WHERE city IS NULL;

-- 4. éªŒè¯ç»“æœ
SELECT 
  role,
  COUNT(*) AS count,
  array_agg(DISTINCT current_city) AS cities_in_use
FROM profiles
GROUP BY role
ORDER BY 
  CASE role
    WHEN 'super_admin' THEN 1
    WHEN 'admin' THEN 2
    WHEN 'manager' THEN 3
    ELSE 4
  END;

-- 5. æœ€ç»ˆæ£€æŸ¥
SELECT 
  CASE 
    WHEN COUNT(*) FILTER (WHERE cities IS NULL OR array_length(cities, 1) IS NULL) = 0 
    THEN 'âœ… æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰åŸå¸‚æƒé™'
    ELSE 'âš ï¸ ä»æœ‰ç”¨æˆ·ç¼ºå°‘åŸå¸‚æƒé™'
  END AS status
FROM profiles;
```

**æœŸæœ›è¾“å‡ºï¼š**
```
âœ… æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰åŸå¸‚æƒé™
```

---

### ç¬¬ 3 æ­¥ï¼šæäº¤ä»£ç å¹¶éƒ¨ç½² â±ï¸ 2åˆ†é’Ÿ

**åœ¨é¡¹ç›®ç›®å½•æ‰§è¡Œï¼š**

```bash
# æŸ¥çœ‹ä¿®æ”¹çš„æ–‡ä»¶
git status

# æ·»åŠ æ‰€æœ‰æ›´æ”¹
git add src/contexts/CityContext.jsx
git add src/components/UserManagement.jsx

# æäº¤
git commit -m "fix: ä¿®å¤åŸå¸‚åˆ‡æ¢æ­»å¾ªç¯å’Œè¶…æ—¶é—®é¢˜

- æ·»åŠ æŸ¥è¯¢å’Œæ›´æ–°è¶…æ—¶ä¿æŠ¤ï¼ˆ5s/3sï¼‰
- ä¿®å¤ super_admin åŸå¸‚æƒé™åˆ¤æ–­é€»è¾‘
- æ·»åŠ é”™è¯¯æ¢å¤æœºåˆ¶ï¼ˆè‡ªåŠ¨å›é€€ï¼‰
- ä¿®å¤ UserManagement åŸå¸‚é€‰é¡¹å¼•ç”¨"

# æ¨é€åˆ°è¿œç¨‹ï¼ˆè§¦å‘ Vercel è‡ªåŠ¨éƒ¨ç½²ï¼‰
git push origin main
```

---

### ç¬¬ 4 æ­¥ï¼šç­‰å¾…éƒ¨ç½²å®Œæˆ â±ï¸ 2-3åˆ†é’Ÿ

**æ£€æŸ¥éƒ¨ç½²çŠ¶æ€ï¼š**

1. è®¿é—®ï¼šhttps://vercel.com/dashboard
2. æ‰¾åˆ°ä½ çš„é¡¹ç›®
3. æŸ¥çœ‹ Deployments é¡µé¢
4. ç­‰å¾…æœ€æ–°éƒ¨ç½²å˜æˆ âœ… ç»¿è‰²

**æˆ–è€…åœ¨ç»ˆç«¯æŸ¥çœ‹ï¼š**
```bash
# å¦‚æœå®‰è£…äº† Vercel CLI
vercel logs
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

éƒ¨ç½²å®Œæˆåï¼ŒæŒ‰é¡ºåºæµ‹è¯•ï¼š

### âœ… æµ‹è¯• 1ï¼šç™»å½•
```
1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆå†æ¬¡ç¡®è®¤ï¼‰
2. é‡æ–°è®¿é—®ç½‘ç«™
3. ç™»å½•è´¦å·
4. âœ“ åº”è¯¥æ­£å¸¸è¿›å…¥é¦–é¡µï¼Œä¸å¡ä½
```

### âœ… æµ‹è¯• 2ï¼šåŸå¸‚åˆ‡æ¢
```
1. ç‚¹å‡»é¡¶éƒ¨åŸå¸‚é€‰æ‹©å™¨ï¼ˆğŸ™ï¸ è¿ˆé˜¿å¯† â–¼ï¼‰
2. é€‰æ‹©å…¶ä»–åŸå¸‚ï¼ˆå¦‚ WPBï¼‰
3. âœ“ åº”è¯¥åœ¨ 3 ç§’å†…å®Œæˆåˆ‡æ¢
4. âœ“ é¡µé¢è‡ªåŠ¨åˆ·æ–°
5. âœ“ æ˜¾ç¤ºæ–°åŸå¸‚åç§°
```

### âœ… æµ‹è¯• 3ï¼šç”¨æˆ·ç®¡ç†ï¼ˆå¦‚æœæ˜¯ Super Adminï¼‰
```
1. ç‚¹å‡»"ç”¨æˆ·ç®¡ç†"
2. âœ“ åº”è¯¥æ­£å¸¸åŠ è½½ï¼Œä¸å¡ä½
3. âœ“ çœ‹åˆ°"åŸå¸‚æƒé™"åˆ—
4. ç‚¹å‡»"åˆ†é…åŸå¸‚"
5. âœ“ Modal æ­£å¸¸æ‰“å¼€
6. é€‰æ‹©åŸå¸‚å¹¶ä¿å­˜
7. âœ“ ä¿å­˜æˆåŠŸï¼Œä¸å¡ä½
```

### âœ… æµ‹è¯• 4ï¼šæ•°æ®éš”ç¦»
```
1. åœ¨ MIA åŸå¸‚æ·»åŠ ä¸€ä¸ªåŒ…è£¹
2. åˆ‡æ¢åˆ° WPB åŸå¸‚
3. âœ“ åº”è¯¥çœ‹ä¸åˆ° MIA çš„åŒ…è£¹
4. åˆ‡æ¢å› MIA
5. âœ“ åŒ…è£¹ä»ç„¶å­˜åœ¨
```

---

## ğŸ› å¦‚æœä»ç„¶å‡ºé—®é¢˜

### æ£€æŸ¥ 1ï¼šæµè§ˆå™¨æ§åˆ¶å°
```
F12 â†’ Console
```
æŸ¥æ‰¾ï¼š
- âŒ çº¢è‰²é”™è¯¯
- "æŸ¥è¯¢è¶…æ—¶" æˆ– "æ›´æ–°è¶…æ—¶"

### æ£€æŸ¥ 2ï¼šç½‘ç»œè¯·æ±‚
```
F12 â†’ Network
```
æŸ¥æ‰¾ï¼š
- â³ Pending è¶…è¿‡ 10 ç§’çš„è¯·æ±‚
- è¯·æ±‚çš„ URL ä¸­æ˜¯å¦æœ‰ `profiles`

### æ£€æŸ¥ 3ï¼šæ•°æ®åº“
åœ¨ Supabase SQL Editor æ‰§è¡Œï¼š
```sql
SELECT id, email, role, cities, current_city 
FROM profiles
WHERE auth.uid() = id;
```
ç¡®è®¤ï¼š
- âœ… `cities` ä¸ä¸ºç©º
- âœ… `current_city` åœ¨ `cities` æ•°ç»„ä¸­

---

## ğŸ”„ ç´§æ€¥å›æ»šï¼ˆå¦‚æœéœ€è¦ï¼‰

å¦‚æœæ–°ä»£ç æœ‰é—®é¢˜ï¼Œç«‹å³å›æ»šï¼š

```bash
# å›é€€åˆ°ä¸Šä¸€æ¬¡æäº¤
git revert HEAD

# æ¨é€å›æ»š
git push origin main
```

---

## ğŸ“Š ä¿®å¤åŸç†

### é—®é¢˜æ ¹å› 
1. **æ— è¶…æ—¶æœºåˆ¶** â†’ æŸ¥è¯¢å¡ä½æ—¶æ— æ³•æ¢å¤
2. **é€»è¾‘é”™è¯¯** â†’ Super Admin åŸå¸‚åˆ¤æ–­å¤±è´¥
3. **æ— é”™è¯¯æ¢å¤** â†’ å¤±è´¥åçŠ¶æ€æ··ä¹±

### ä¿®å¤æ–¹æ¡ˆ
```javascript
// æ·»åŠ è¶…æ—¶ä¿æŠ¤
const timeout = new Promise((_, reject) => 
  setTimeout(() => reject(new Error('æŸ¥è¯¢è¶…æ—¶')), 5000)
)
await Promise.race([queryPromise, timeout])

// ä¿®å¤é€»è¾‘
let accessibleCities = cities
if (role === 'super_admin') {
  accessibleCities = ALL_CITIES // æ‰€æœ‰åŸå¸‚
}

// é”™è¯¯æ¢å¤
try {
  setCurrentCity(newCity) // ä¹è§‚æ›´æ–°
  await updateDB()
} catch (error) {
  setCurrentCity(previousCity) // å›é€€
  alert('åˆ‡æ¢å¤±è´¥')
}
```

---

## âœ¨ å®Œæˆåçš„æ•ˆæœ

1. âœ… åŸå¸‚åˆ‡æ¢ < 3 ç§’å®Œæˆ
2. âœ… è¶…æ—¶è‡ªåŠ¨æç¤ºå¹¶å›é€€
3. âœ… Super Admin å¯è®¿é—®æ‰€æœ‰åŸå¸‚
4. âœ… ç”¨æˆ·ç®¡ç†æ­£å¸¸æ‰“å¼€
5. âœ… æ•°æ®å®Œå…¨éš”ç¦»
6. âœ… ä¸å†å‡ºç° Loading æ­»å¾ªç¯

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼š

1. **å“ªä¸€æ­¥å¡ä½äº†ï¼Ÿ**ï¼ˆ1/2/3/4ï¼‰
2. **æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯**ï¼ˆF12 â†’ Console æˆªå›¾ï¼‰
3. **Vercel éƒ¨ç½²æ—¥å¿—**ï¼ˆå¦‚æœéƒ¨ç½²å¤±è´¥ï¼‰

**ç°åœ¨å°±å¼€å§‹æ‰§è¡Œç¬¬ 1 æ­¥ï¼** ğŸš€

