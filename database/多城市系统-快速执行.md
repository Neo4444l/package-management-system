# 🚀 多城市系统 - 快速执行指南

## ⚠️ 重要提示

**执行前请确保：**
1. 已经备份数据库
2. 在测试环境先验证
3. 理解此操作会修改现有数据

---

## 📝 执行步骤

### 步骤1：打开 Supabase SQL 编辑器

1. 访问：https://supabase.com
2. 选择您的项目
3. 点击左侧 "SQL Editor"
4. 点击 "New query"

### 步骤2：执行 SQL 脚本

1. 打开文件：`database/多城市系统-完整配置.sql`
2. 复制全部内容（330行）
3. 粘贴到 Supabase SQL 编辑器
4. 点击 "Run" 按钮
5. 等待执行完成

### 步骤3：验证执行结果

执行完成后，查看输出结果，应该显示类似：

```
表名          总记录数  角色数量  有城市权限的用户数
profiles 表      5        4         5
packages 表      100      1         100
locations 表     20       1         20
```

---

## ✅ 执行后的变化

### 1. profiles 表
- ✅ 新增字段：`cities TEXT[]` - 用户授权的城市列表
- ✅ 新增字段：`current_city TEXT` - 当前选择的城市
- ✅ 第一个用户的 role 变为 `super_admin`
- ✅ 第一个用户的 cities 包含所有城市
- ✅ 其他用户的 cities 默认为 `['MIA']`

### 2. packages 表
- ✅ 新增字段：`city TEXT` - 包裹所属城市
- ✅ 现有包裹的 city 设置为 `MIA`
- ✅ 新增索引以提高查询性能

### 3. locations 表
- ✅ 新增字段：`city TEXT` - 库位所属城市
- ✅ 现有库位的 city 设置为 `MIA`
- ✅ 唯一约束：同一城市内库位号不能重复

### 4. RLS 策略
- ✅ 更新所有表的行级安全策略
- ✅ 实现基于城市的数据隔离
- ✅ 分级权限管理（super_admin > admin > manager > user）

---

## 🔍 验证数据

### 查询1：检查用户城市权限

```sql
SELECT 
  email,
  role,
  cities,
  current_city
FROM profiles
ORDER BY created_at;
```

**预期结果：**
- 第一个用户：role = 'super_admin', cities = ['MIA','WPB','FTM','MCO','TPA']
- 其他用户：role = 原有角色, cities = ['MIA']

### 查询2：检查包裹城市分配

```sql
SELECT 
  city,
  COUNT(*) as package_count
FROM packages
GROUP BY city;
```

**预期结果：**
```
city | package_count
MIA  |     100
```

### 查询3：检查库位城市分配

```sql
SELECT 
  city,
  COUNT(*) as location_count
FROM locations
GROUP BY city;
```

**预期结果：**
```
city | location_count
MIA  |     20
```

---

## 🐛 常见错误及解决方案

### 错误1：`column "cities" already exists`
**原因：** 脚本已经执行过
**解决：** 无需重复执行，跳过此错误即可

### 错误2：`relation "profiles" does not exist`
**原因：** profiles 表还未创建
**解决：** 先执行 `database/权限管理系统-完整SQL.sql`

### 错误3：`permission denied`
**原因：** 数据库权限不足
**解决：** 确保使用管理员账号执行

### 错误4：`cannot drop index locations_code_key`
**原因：** 旧版脚本尝试删除约束而非索引
**解决：** 已修复，重新复制最新的SQL脚本执行

### 错误5：`column "status" does not exist`
**原因：** 字段名不匹配，原系统使用 `is_active` 而非 `status`
**解决：** 已修复，重新复制最新的SQL脚本执行

### 错误6：`type "user_role" does not exist` (函数中)
**原因：** 函数中的变量声明使用了不存在的枚举类型
**解决：** 已修复，将变量类型改为 TEXT

---

## 🎯 执行后立即测试

### 测试1：登录系统
1. 刷新浏览器
2. 使用第一个注册的账号登录
3. 应该看到角色徽章显示 "Super Admin"（紫色）

### 测试2：查看城市选择器
1. 登录后查看右上角
2. 应该看到城市选择器：`🏙️ 迈阿密 ▼`
3. 点击可以看到所有5个城市

### 测试3：切换城市
1. 点击城市选择器
2. 选择任意其他城市（如 WPB）
3. 页面会刷新
4. 右上角显示新选择的城市

---

## 📊 数据库结构变化

### 之前
```
profiles
├── id
├── email
├── full_name
├── role (TEXT)
└── ...

packages
├── id
├── package_number
├── location
└── ...

locations
├── id
└── code
```

### 之后
```
profiles
├── id
├── email
├── full_name
├── role (TEXT: 'super_admin', 'admin', 'manager', 'user')
├── cities (TEXT[])  ← 新增
├── current_city (TEXT)  ← 新增
└── ...

packages
├── id
├── package_number
├── location
├── city (TEXT)  ← 新增
└── ...

locations
├── id
├── code
├── city (TEXT)  ← 新增
└── ...
```

---

## 🎉 成功标志

执行成功后，您应该看到：

1. ✅ SQL 执行完成，无错误
2. ✅ 验证查询返回预期结果
3. ✅ 登录系统看到城市选择器
4. ✅ Super Admin 徽章显示为紫色
5. ✅ 可以切换城市

---

## 🔄 回滚方案（如需）

如果需要回滚更改：

```sql
-- 移除城市相关字段
ALTER TABLE profiles 
DROP COLUMN IF EXISTS cities,
DROP COLUMN IF EXISTS current_city;

ALTER TABLE packages 
DROP COLUMN IF EXISTS city;

ALTER TABLE locations 
DROP COLUMN IF EXISTS city;

-- 恢复 RLS 策略（需要重新执行原始的 RLS 脚本）
```

⚠️ **注意：** 回滚会丢失所有城市配置数据！

---

## 📞 需要帮助？

如果遇到问题：
1. 检查 Supabase 的日志输出
2. 确认 profiles 表已存在
3. 确认当前用户有管理员权限
4. 查看详细错误信息

---

**🌟 准备好了吗？现在就执行SQL脚本吧！** 🚀

---

*更新时间：2025年10月*
*当前版本：v1.0 - 修复版*

