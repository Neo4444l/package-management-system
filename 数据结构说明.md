# 退回包裹管理系统 - 数据结构说明

## 新版数据结构（已优化）

### 核心改进

1. **状态和指令分离**
   - `packageStatus`: 包裹的物理状态（在库内/待下架/已下架）
   - `customerService`: 客服下达的指令（重派/重派新面单/退回客户）

2. **完整的时间记录**
   - `shelvingTime`: 上架时间
   - `unshelvingTime`: 下架时间
   - `instructionTime`: 下达指令时间

3. **数据不删除**
   - 下架后标记为"已下架"状态，保留在数据库中
   - 可在中心退回管理中查看历史记录
   - 需要删除时，通过"管理"按钮手动删除

---

## 包裹数据字段说明

```javascript
{
  // 基础信息
  "id": 1697123456789,              // 唯一ID
  "packageNumber": "PKG001",         // 运单号
  "location": "A-01",                // 库位号
  
  // 状态信息（分离的两个维度）
  "packageStatus": "in-warehouse",   // 包裹状态
  "customerService": "re-dispatch",  // 客服指令
  
  // 时间记录
  "shelvingTime": "2025-10-15T08:30:00.000Z",
  "shelvingTimeDisplay": "2025/10/15 16:30:00",
  "unshelvingTime": "2025-10-15T10:30:00.000Z",
  "unshelvingTimeDisplay": "2025/10/15 18:30:00",
  "instructionTime": "2025-10-15T09:00:00.000Z",
  "instructionTimeDisplay": "2025/10/15 17:00:00",
  
  // 历史记录
  "statusHistory": [
    {
      "action": "instruction",         // 操作类型
      "customerService": "re-dispatch", // 指令内容
      "changedAt": "2025-10-15T09:00:00.000Z",
      "changedAtDisplay": "2025/10/15 17:00:00"
    },
    {
      "action": "unshelving",          // 下架操作
      "packageStatus": "removed",
      "changedAt": "2025-10-15T10:30:00.000Z",
      "changedAtDisplay": "2025/10/15 18:30:00"
    }
  ]
}
```

---

## 状态值说明

### packageStatus（包裹状态）

| 值 | 中文名称 | 说明 | 颜色 |
|---|---------|------|------|
| `in-warehouse` | 在库内 | 包裹已上架，在仓库中 | 🟢 绿色 |
| `pending-removal` | 待下架 | 已下达客服指令，等待下架 | 🟠 橙色 |
| `removed` | 已下架 | 已完成下架操作 | ⚫ 灰色 |

### customerService（客服指令）

| 值 | 中文名称 | 说明 | 颜色 |
|---|---------|------|------|
| `re-dispatch` | 重派 | 重新派送 | 🟣 紫色 |
| `re-dispatch-new-label` | 重派（新面单） | 使用新面单重新派送 | 🟪 深紫色 |
| `return-to-customer` | 退回客户 | 退回给客户 | 🔴 红色 |
| `null` | - | 未下达指令 | - |

---

## 工作流程

### 1. 上架流程
```
[上架] → packageStatus: in-warehouse
       → shelvingTime: 记录时间
       → customerService: null
```

### 2. 下达指令流程
```
[中心退回管理 - 选择运单 - 指令下达]
→ packageStatus: pending-removal (自动更新)
→ customerService: 're-dispatch' | 're-dispatch-new-label' | 'return-to-customer'
→ instructionTime: 记录时间
```

### 3. 下架流程
```
[下架 - 扫描运单号 - 确认下架]
→ packageStatus: removed
→ unshelvingTime: 记录时间
→ customerService: 保持不变
```

### 4. 删除流程（可选）
```
[中心退回管理 - 管理 - 删除运单]
→ 从数据库中永久删除
```

---

## 筛选维度

### 中心退回管理

#### 状态筛选
- 全部
- 在库内 (`packageStatus === 'in-warehouse'`)
- 待下架 (`packageStatus === 'pending-removal'`)
- 已下架 (`packageStatus === 'removed'`)

#### 客服指令筛选
- 重派 (`customerService === 're-dispatch'`)
- 重派（新面单） (`customerService === 're-dispatch-new-label'`)
- 退回客户 (`customerService === 'return-to-customer'`)

#### 时间筛选
- 上架时间范围
- 下架时间范围
- 下达指令时间范围

### 下架模块

只显示：`packageStatus === 'pending-removal'` 的运单

---

## 数据迁移

### 从旧版数据结构迁移

如果系统中有旧版数据（使用 `status` 字段），会自动转换：

```javascript
// 旧数据
{
  "status": "in-stock"
}

// 自动转换为
{
  "packageStatus": "in-warehouse",
  "customerService": null
}
```

转换规则：
- `status: 'in-stock'` → `packageStatus: 'in-warehouse'`
- 其他旧状态 → `packageStatus: 'in-warehouse'`（默认值）
- `customerService` → `null`（默认值）

---

## 最佳实践

1. **不要直接删除数据**
   - 下架后的数据保留为"已下架"状态
   - 便于历史查询和统计分析

2. **完整的时间记录**
   - 三个时间维度完整记录操作历史
   - 支持按时间筛选和报表统计

3. **状态和指令分离**
   - 物理状态（在库/待下架/已下架）
   - 业务指令（重派/退回等）
   - 清晰的数据结构，便于扩展

4. **历史记录**
   - `statusHistory` 记录所有操作
   - 便于追溯和审计

---

## 表格展示

中心退回管理表格列：

| 列名 | 数据源 | 说明 |
|-----|-------|------|
| 运单号 | `packageNumber` | 唯一标识 |
| 库位 | `location` | 所在库位 |
| 状态 | `packageStatus` | 包裹物理状态 |
| 客服指令 | `customerService` | 业务指令 |
| 上架时间 | `shelvingTimeDisplay` | 上架操作时间 |
| 下架时间 | `unshelvingTimeDisplay` | 下架操作时间 |
| 下达指令时间 | `instructionTimeDisplay` | 指令下达时间 |
| 操作 | - | 管理按钮 |

---

## 示例场景

### 场景1：正常重派流程

1. 上架：`packageStatus: 'in-warehouse'`, `customerService: null`
2. 下达重派指令：`packageStatus: 'pending-removal'`, `customerService: 're-dispatch'`
3. 下架：`packageStatus: 'removed'`, `customerService: 're-dispatch'`

### 场景2：退回客户流程

1. 上架：`packageStatus: 'in-warehouse'`, `customerService: null`
2. 下达退回指令：`packageStatus: 'pending-removal'`, `customerService: 'return-to-customer'`
3. 下架：`packageStatus: 'removed'`, `customerService: 'return-to-customer'`

---

## 技术实现

### LocalStorage 存储

- Key: `packages`
- Value: JSON字符串（数组）
- 每次操作后立即保存

### 数据查询优化

使用 `filter()` 方法进行多维度筛选：

```javascript
// 状态筛选
packages.filter(pkg => pkg.packageStatus === 'pending-removal')

// 指令筛选
packages.filter(pkg => pkg.customerService === 're-dispatch')

// 时间筛选
packages.filter(pkg => {
  const time = new Date(pkg.shelvingTime).getTime()
  return time >= startTime && time <= endTime
})
```

---

更新时间：2025-10-15
版本：2.0




