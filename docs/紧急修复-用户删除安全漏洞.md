# 🚨 紧急修复：用户删除安全漏洞

## 📋 问题描述

**严重性：🔴 高危**

当管理员从"用户管理"中删除一个用户后，该用户仍然可以使用账号密码登录系统！

虽然登录时会弹出"访问被阻止"的提示，但点击确定后，用户仍然能够进入系统并进行操作。

---

## 🔍 问题根源

### Supabase 的双层用户系统

Supabase 使用两个独立的表来管理用户：

1. **`auth.users`** 
   - 存储登录凭证（邮箱/密码）
   - 由 Supabase Auth 系统管理
   - 用于身份验证

2. **`public.profiles`**
   - 存储用户元数据（角色、权限、城市等）
   - 由应用程序管理
   - 用于权限控制

### 旧代码的问题

#### 1️⃣ **删除逻辑不完整**（`UserManagement.jsx`）

```javascript
// 旧代码：只删除了 profiles 表
const { error } = await supabase
  .from('profiles')
  .delete()
  .eq('id', userId)
```

**问题**：只删除了 `profiles` 表的记录，但 `auth.users` 中的账号仍然存在！

#### 2️⃣ **登录验证不严格**（`UserContext.jsx`）

```javascript
// 旧代码：查询失败后给予默认权限
catch (error) {
  console.error('获取用户角色失败:', error)
  setUserRole('user')  // ❌ 危险！给了默认权限
  setUsername(session?.user?.email?.split('@')[0] || 'User')
}
```

**问题**：当 `profiles` 表找不到用户记录时，系统不是拒绝访问，而是给予了默认 `user` 角色！

#### 3️⃣ **攻击流程**

```
1. 管理员删除用户
   ↓
2. profiles 表的记录被删除 ✅
   ↓
3. auth.users 中的账号仍然存在 ❌
   ↓
4. 被删除的用户尝试登录
   ↓
5. Auth 验证通过（因为 auth.users 中有记录）✅
   ↓
6. fetchUserRole 查询 profiles 失败 ❌
   ↓
7. 系统给予默认 'user' 角色 ❌
   ↓
8. 用户成功进入系统！🚨
```

---

## ✅ 修复方案

### 第1步：修复前端验证逻辑

#### 修改 `src/contexts/UserContext.jsx`

**核心改动**：当找不到用户 `profile` 或用户被停用时，**强制登出**而不是给予默认权限。

```javascript
const fetchUserRole = async (userId) => {
  try {
    const { data, error } = await supabase
      .from('profiles')
      .select('role, is_active, username')
      .eq('id', userId)
      .single()

    // ✅ 如果找不到 profile，强制登出
    if (error) {
      console.error('❌ 获取用户资料失败:', error)
      await supabase.auth.signOut()
      setSession(null)
      setUserRole(null)
      setUsername('')
      setLoading(false)
      return
    }

    // ✅ 检查用户是否被停用
    if (!data.is_active) {
      console.warn('⚠️ 用户账号已被停用')
      alert('您的账号已被停用，请联系管理员。')
      await supabase.auth.signOut()
      setSession(null)
      setUserRole(null)
      setUsername('')
      setLoading(false)
      return
    }

    setUserRole(data?.role || 'user')
    setUsername(data?.username || session?.user?.email?.split('@')[0] || 'User')
  } catch (error) {
    // ✅ 任何错误都强制登出
    console.error('获取用户角色失败:', error)
    await supabase.auth.signOut()
    setSession(null)
    setUserRole(null)
    setUsername('')
  } finally {
    setLoading(false)
  }
}
```

**修复效果**：
- ✅ 没有 `profile` 的用户无法进入系统
- ✅ 被停用（`is_active = false`）的用户会被强制登出
- ✅ 删除用户后，即使只删除 `profiles` 记录，被删用户也无法操作

---

### 第2步：增强数据库安全策略

#### 执行 SQL 脚本

在 Supabase SQL Editor 中执行 `database/修复用户删除安全漏洞.sql`

**脚本功能**：

1. **添加 DELETE RLS 策略**
   ```sql
   CREATE POLICY "管理员可以删除用户资料"
     ON profiles FOR DELETE
     USING (
       EXISTS (
         SELECT 1 FROM profiles p
         WHERE p.id = auth.uid()
         AND p.role IN ('admin', 'super_admin')
         AND p.is_active = true
       )
     );
   ```
   - 只有激活的管理员可以删除用户
   - 防止未授权的删除操作

2. **创建安全删除函数**
   ```sql
   CREATE FUNCTION delete_user_completely(target_user_id UUID)
   ```
   - 同时删除 `auth.users` 和 `profiles` 中的记录
   - 包含权限检查和操作日志
   - 使用 `SECURITY DEFINER` 提权执行

3. **增强 is_active 检查**
   - 更新所有 RLS 策略，确保只有激活用户可以操作
   - 创建 `is_user_valid()` 辅助函数

---

## 🧪 测试修复效果

### 测试场景 1：删除用户后尝试登录

1. **操作**：
   - 以管理员身份登录
   - 进入"用户管理"
   - 删除一个测试用户

2. **预期结果**：
   - ✅ 用户从列表中消失
   - ✅ 被删除的用户尝试登录时：
     - Auth 验证可能成功（如果只删除了 profiles）
     - 但会立即被 UserContext 检测到并强制登出
     - 显示"您的账号已被停用，请联系管理员"或直接返回登录页

3. **旧行为（已修复）**：
   - ❌ 用户可以登录
   - ❌ 弹出提示但点确定后仍能进入系统
   - ❌ 可以进行操作

---

### 测试场景 2：停用用户

1. **操作**：
   - 点击用户的"激活/停用"状态切换按钮
   - 将用户设置为"停用"

2. **预期结果**：
   - ✅ 如果该用户正在线，会在下次数据操作时被强制登出
   - ✅ 被停用的用户无法登录
   - ✅ 尝试登录会被立即登出

---

### 测试场景 3：RLS 策略测试

1. **操作**：
   - 使用非管理员账号尝试删除用户（通过API）

2. **预期结果**：
   - ✅ 操作被拒绝
   - ✅ 返回权限错误

---

## 🛡️ 安全改进总结

| 问题 | 修复前 | 修复后 |
|-----|-------|-------|
| 删除用户后能否登录 | ❌ 可以登录并操作 | ✅ 被强制登出 |
| 停用用户能否登录 | ⚠️ 可能可以 | ✅ 立即被登出 |
| 没有 profile 的账号 | ❌ 获得默认权限 | ✅ 无法进入系统 |
| DELETE 权限控制 | ❌ 没有策略 | ✅ 只有管理员可删除 |
| Auth/Profile 不一致 | ❌ 允许访问 | ✅ 强制登出 |

---

## 📝 后续建议

### 建议 1：定期清理孤立的 Auth 账号

创建一个定期任务来清理 `auth.users` 中没有对应 `profiles` 的孤立账号：

```sql
-- 查找孤立账号
SELECT u.id, u.email, u.created_at
FROM auth.users u
LEFT JOIN public.profiles p ON u.id = p.id
WHERE p.id IS NULL;

-- 删除孤立账号（谨慎执行！）
DELETE FROM auth.users
WHERE id IN (
  SELECT u.id
  FROM auth.users u
  LEFT JOIN public.profiles p ON u.id = p.id
  WHERE p.id IS NULL
);
```

### 建议 2：使用新的安全删除函数（可选）

如果需要彻底删除用户（包括 auth.users），可以在前端调用新创建的函数：

```javascript
// 使用 RPC 调用数据库函数
const { data, error } = await supabase
  .rpc('delete_user_completely', {
    target_user_id: userId
  })

if (data?.success) {
  alert(data.message)
} else {
  alert('删除失败: ' + (data?.message || error.message))
}
```

### 建议 3：添加操作日志

如果还没有 `operation_logs` 表，建议创建一个来记录敏感操作：

```sql
CREATE TABLE operation_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES profiles(id),
  operation_type TEXT NOT NULL,
  table_name TEXT,
  record_id UUID,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## ⚡ 立即执行步骤

1. ✅ **已完成**：前端代码已自动更新（`UserContext.jsx`）

2. **执行数据库脚本**：
   ```bash
   1. 打开 Supabase Dashboard
   2. 进入 SQL Editor
   3. 执行 database/修复用户删除安全漏洞.sql
   4. 查看执行结果
   ```

3. **测试修复**：
   - 创建一个测试用户
   - 删除该用户
   - 尝试用该账号登录
   - 确认被阻止访问

4. **通知用户**：
   - 如果有被删除但仍在使用的账号，他们会在下次操作时被强制登出
   - 建议所有管理员强制刷新浏览器

---

## 🆘 故障排查

### 问题：用户仍然可以登录

**检查清单**：

1. ✅ 确认前端代码已更新（`UserContext.jsx`）
2. ✅ 确认已强制刷新浏览器（Ctrl+Shift+R）
3. ✅ 确认数据库脚本执行成功
4. ✅ 检查用户的 `is_active` 状态是否为 `true`
5. ✅ 检查浏览器控制台是否有错误

### 问题：管理员无法删除用户

**可能原因**：

1. RLS 策略未生效 → 重新执行 SQL 脚本
2. 管理员账号 `is_active = false` → 检查数据库
3. 权限不足 → 确认角色为 `admin` 或 `super_admin`

---

## 📞 技术支持

如果遇到问题：

1. 查看浏览器控制台错误信息
2. 查看 Supabase Dashboard → Logs
3. 检查 `profiles` 表的 RLS 策略是否正确启用
4. 确认所有用户都强制刷新了浏览器

---

**修复完成日期**：2025-12-09  
**严重性等级**：🔴 高危  
**修复状态**：✅ 已完成  

