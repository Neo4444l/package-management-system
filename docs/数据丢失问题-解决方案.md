# 📋 数据丢失问题 - 完整解决方案

## 🔍 问题描述

系统发现 A-10-18-2025 到 A-10-25-2025 的库位数据丢失（显示为 0 件）。

## ❓ 可能的原因

### 1. **数据并未丢失 - RLS 权限问题**
- 数据仍在数据库中，但由于行级安全（RLS）策略，当前用户无法查看
- 可能原因：城市权限配置错误

### 2. **数据并未丢失 - 城市过滤问题**
- 数据属于其他城市，但当前城市切换后看不到
- 可能原因：库位创建时城市字段设置错误

### 3. **数据真的丢失 - 误删除**
- 管理员或有权限的用户误删除了库位
- 删除库位时，关联的包裹也会被删除（见 `LocationManagement.jsx:189-198`）

### 4. **Supabase 免费版限制**
- 免费版有存储限制（500MB）
- 达到限制后可能无法写入新数据
- 但**不会自动删除旧数据**

## 🛠️ 解决步骤

### 第一步：诊断问题

1. 登录 [Supabase Dashboard](https://supabase.com)
2. 选择您的项目
3. 点击左侧 **SQL Editor**
4. 点击 **New query**
5. 打开文件 `database/数据丢失诊断.sql`
6. 复制全部内容并粘贴到编辑器
7. 点击 **Run** 执行

#### 查看诊断结果

**场景A：数据仍然存在**
```sql
-- 如果看到这样的结果，说明数据没丢失
 code           | city | created_at
----------------|------|------------
 A-10-18-2025   | MIA  | 2025-10-18
 A-10-19-2025   | MIA  | 2025-10-19
```
→ **问题原因**：权限或过滤问题  
→ **解决方案**：检查用户城市权限配置

**场景B：数据不存在**
```sql
-- 查询结果为空
 code           | city | created_at
----------------|------|------------
 (0 rows)
```
→ **问题原因**：数据被删除  
→ **解决方案**：执行恢复脚本

---

### 第二步：根据诊断结果采取行动

#### 🔧 方案1：数据存在 - 修复权限问题

1. 在 SQL Editor 中执行：

```sql
-- 检查当前用户的城市权限
SELECT 
  email,
  role,
  cities,
  current_city
FROM profiles
WHERE id = auth.uid();
```

2. 如果 `cities` 不包含 `MIA`，执行：

```sql
-- 添加 MIA 城市权限（替换 your_email@example.com）
UPDATE profiles
SET cities = array_append(cities, 'MIA')
WHERE email = 'your_email@example.com'
AND NOT ('MIA' = ANY(cities));
```

#### 🔧 方案2：数据丢失 - 恢复库位

1. 在 SQL Editor 中打开新查询
2. 打开文件 `database/恢复丢失的库位.sql`
3. 复制全部内容并粘贴
4. 点击 **Run** 执行

脚本会：
- ✅ 重新创建 A-10-18 到 A-10-25 的库位
- ✅ 创建删除审计日志（防止未来再次发生）
- ✅ 记录所有删除操作

---

### 第三步：验证修复

1. 刷新前端页面（按 `Ctrl + F5` 强制刷新）
2. 进入 **上架管理** 页面
3. 检查库位列表是否恢复
4. 确认 A-10-18-2025 到 A-10-25-2025 都显示

---

## 🛡️ 防止未来再次发生

### 1. 启用删除审计日志

运行 `database/恢复丢失的库位.sql` 中的触发器部分，所有删除操作会记录到 `operation_logs` 表：

```sql
-- 查看最近的删除记录
SELECT 
  user_email,
  action,
  details->>'code' as deleted_location,
  created_at
FROM operation_logs
WHERE action = 'DELETE_LOCATION'
ORDER BY created_at DESC;
```

### 2. 定期导出数据备份

#### 方法A：Supabase Dashboard 导出

1. 进入 **Table Editor**
2. 选择 `locations` 表
3. 点击右上角 **...** → **Download as CSV**
4. 每周导出一次保存到本地

#### 方法B：使用前端导出功能

1. 进入 **中心退件管理** 页面
2. 点击 **导出数据** 按钮
3. 定期保存 JSON 文件

### 3. 限制删除权限

修改 RLS 策略，只允许 super_admin 删除：

```sql
-- 更严格的删除策略
DROP POLICY IF EXISTS "管理员可以删除授权城市的库位" ON locations;

CREATE POLICY "只有super_admin可以删除库位"
  ON locations FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'super_admin'  -- 只有超级管理员
    )
  );
```

### 4. 添加删除确认

前端已有确认对话框（`LocationManagement.jsx:176-187`），但可以增强：

```javascript
// 建议：删除前要求输入库位号确认
const confirmed = window.confirm(
  `⚠️ 警告：删除库位将无法恢复！\n\n` +
  `即将删除：${location.code}\n` +
  `包含包裹：${packageCount} 件\n\n` +
  `请在下一步输入库位号确认删除。`
);

if (confirmed) {
  const input = prompt(`请输入库位号 "${location.code}" 以确认删除：`);
  if (input === location.code) {
    // 执行删除
  } else {
    alert('库位号不匹配，取消删除');
  }
}
```

---

## 📊 查看删除历史

如果启用了审计日志，可以随时查看谁删除了什么：

```sql
-- 查看库位删除记录
SELECT 
  user_email,
  details->>'code' as location_code,
  details->>'city' as city,
  details->>'deleted_at' as deleted_at
FROM operation_logs
WHERE action = 'DELETE_LOCATION'
ORDER BY created_at DESC;

-- 查看包裹删除记录
SELECT 
  user_email,
  details->>'package_number' as package_number,
  details->>'location' as location,
  details->>'deleted_at' as deleted_at
FROM operation_logs
WHERE action = 'DELETE_PACKAGE'
ORDER BY created_at DESC
LIMIT 50;
```

---

## 🆘 常见问题

### Q1：执行恢复脚本后仍然看不到数据？

**A：** 可能是前端缓存问题
1. 按 `Ctrl + Shift + Delete` 清除浏览器缓存
2. 或使用无痕模式重新登录
3. 检查是否选择了正确的城市

### Q2：恢复的库位没有包裹数据？

**A：** 包裹数据确实丢失了
- 库位删除时，关联的包裹也会被级联删除
- 需要从备份恢复（如果有）
- 或者重新上架包裹

### Q3：如何判断是否有自动删除任务？

**A：** 运行诊断脚本中的检查：
```sql
-- 检查定时任务
SELECT * FROM cron.job;

-- 检查触发器
SELECT * FROM information_schema.triggers WHERE trigger_schema = 'public';
```

如果结果为空或只有审计日志触发器，说明**没有自动删除**。

### Q4：Supabase 免费版会自动删除数据吗？

**A：** 不会
- Supabase 免费版有存储限制（500MB 数据库 + 1GB 文件存储）
- 达到限制后会**阻止新数据写入**
- 但**不会自动删除已有数据**
- 只有手动删除或通过代码/SQL删除

---

## 📝 总结

1. ✅ 执行 `database/数据丢失诊断.sql` 确认问题
2. ✅ 根据诊断结果选择修复方案
3. ✅ 运行 `database/恢复丢失的库位.sql` 恢复数据
4. ✅ 启用审计日志防止未来问题
5. ✅ 定期备份数据

---

## 📞 需要帮助？

如果问题仍未解决，请提供以下信息：

1. 诊断脚本的完整输出结果
2. 当前登录用户的邮箱
3. 使用的 Supabase 项目 ID
4. 问题发生的具体时间

---

**创建时间：** 2025-10-29  
**最后更新：** 2025-10-29


