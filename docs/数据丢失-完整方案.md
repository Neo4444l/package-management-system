# 📦 数据丢失问题 - 完整诊断与解决方案

## 📖 问题概述

您反映系统中 **A-10-18-2025 到 A-10-25-2025** 的库位数据丢失（显示 0 件包裹）。

经过代码审查，我确认：
- ✅ **代码中没有自动删除逻辑**
- ✅ **数据库没有定时删除任务**
- ✅ **Supabase 不会自动删除数据**

因此，数据丢失的原因只有两种可能：
1. **数据仍然存在**，但因为权限或过滤问题无法显示
2. **数据被手动删除**（管理员操作或误删）

---

## 🎯 解决方案概览

我为您准备了完整的解决方案，包含 4 个文件：

| 文件名 | 用途 | 耗时 |
|--------|------|------|
| `database/数据丢失诊断.sql` | 全面诊断数据状态 | 2-3 分钟 |
| `database/恢复丢失的库位.sql` | 恢复数据 + 启用审计日志 | 2 分钟 |
| `docs/数据丢失问题-解决方案.md` | 详细步骤说明（本文档） | 阅读 5 分钟 |
| `docs/快速修复-数据丢失.md` | 紧急快速修复指南 | 执行 5 分钟 |

**推荐路径：**
- 🚨 **紧急情况**：直接阅读 `快速修复-数据丢失.md`（5分钟搞定）
- 📚 **详细了解**：阅读本文档完整版

---

## 🔍 第一步：诊断问题

### 方法 1：快速诊断（推荐）

1. 登录 Supabase Dashboard
2. SQL Editor → New query
3. 执行以下代码：

```sql
-- 快速检查：数据是否存在
ALTER TABLE locations DISABLE ROW LEVEL SECURITY;

SELECT 
  code,
  city,
  created_at,
  (SELECT COUNT(*) FROM packages WHERE packages.location = locations.code) as package_count
FROM locations
WHERE code BETWEEN 'A-10-18-2025' AND 'A-10-25-2025'
ORDER BY code;

ALTER TABLE locations ENABLE ROW LEVEL SECURITY;
```

**结果判断：**

#### 场景 A：有数据返回
```
 code           | city | created_at          | package_count
----------------|------|---------------------|---------------
 A-10-18-2025   | MIA  | 2025-10-18 00:00:00 | 0
 A-10-19-2025   | MIA  | 2025-10-19 00:00:00 | 5
```
→ **结论：数据没丢失，是权限问题**  
→ **解决方案：** 跳到 [修复权限](#修复权限问题)

#### 场景 B：无数据返回
```
 code           | city | created_at          | package_count
----------------|------|---------------------|---------------
 (0 rows)
```
→ **结论：数据被删除了**  
→ **解决方案：** 跳到 [恢复数据](#恢复被删除的数据)

---

### 方法 2：完整诊断

使用 `database/数据丢失诊断.sql` 进行全面检查：

```sql
-- 这个脚本会检查：
-- 1. 数据是否真的丢失
-- 2. 是否有软删除标记
-- 3. 是否有自动删除触发器
-- 4. 是否有定时任务
-- 5. 最近的删除操作记录
```

详细步骤：
1. 打开 `database/数据丢失诊断.sql`
2. 复制全部内容
3. 在 Supabase SQL Editor 中粘贴
4. 点击 Run
5. 查看输出结果

---

## 🔧 第二步：根据诊断结果修复

### 修复权限问题

如果诊断显示数据存在，但前端看不到：

#### 原因分析

1. **城市权限不足**：用户的 `cities` 字段不包含该城市
2. **RLS 策略问题**：行级安全策略阻止访问
3. **前端城市过滤**：当前选择的城市不对

#### 解决方案

**步骤 1：检查当前用户权限**

```sql
SELECT 
  email,
  role,
  cities,
  current_city,
  is_active
FROM profiles
WHERE id = auth.uid();
```

**步骤 2：添加城市权限**

```sql
-- 替换成您的邮箱
UPDATE profiles
SET cities = ARRAY['MIA', 'WPB', 'FTM', 'MCO', 'TPA']
WHERE email = 'your_email@example.com';
```

**步骤 3：验证**

```sql
-- 再次检查权限
SELECT cities FROM profiles WHERE email = 'your_email@example.com';
```

**步骤 4：刷新前端**

- 按 `Ctrl + F5` 强制刷新
- 或清除浏览器缓存后重新登录

---

### 恢复被删除的数据

如果诊断显示数据确实被删除：

#### 方法 1：快速恢复（推荐）

```sql
-- 批量插入丢失的库位
INSERT INTO locations (code, city, created_at)
VALUES
  ('A-10-18-2025', 'MIA', '2025-10-18 00:00:00+00'),
  ('A-10-19-2025', 'MIA', '2025-10-19 00:00:00+00'),
  ('A-10-20-2025', 'MIA', '2025-10-20 00:00:00+00'),
  ('A-10-21-2025', 'MIA', '2025-10-21 00:00:00+00'),
  ('A-10-22-2025', 'MIA', '2025-10-22 00:00:00+00'),
  ('A-10-23-2025', 'MIA', '2025-10-23 00:00:00+00'),
  ('A-10-24-2025', 'MIA', '2025-10-24 00:00:00+00'),
  ('A-10-25-2025', 'MIA', '2025-10-25 00:00:00+00')
ON CONFLICT (city, code) DO NOTHING;

-- 验证恢复结果
SELECT code, city, created_at 
FROM locations 
WHERE code BETWEEN 'A-10-18-2025' AND 'A-10-25-2025'
ORDER BY code;
```

#### 方法 2：使用完整恢复脚本

执行 `database/恢复丢失的库位.sql`，它会：
1. ✅ 恢复丢失的库位
2. ✅ 创建删除审计日志触发器
3. ✅ 防止未来再次发生

**注意：** 库位被删除时，关联的包裹数据也会被删除（级联删除）。  
如果需要恢复包裹数据，需要从备份中恢复。

---

## 🛡️ 第三步：防止未来再次发生

### 1. 启用删除审计日志

**重要性：** 记录所有删除操作，可追溯谁在何时删除了什么。

#### 安装审计日志触发器

```sql
-- 库位删除审计
CREATE OR REPLACE FUNCTION log_location_deletion()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO operation_logs (
    user_id,
    user_email,
    action,
    target_type,
    target_id,
    details,
    created_at
  )
  VALUES (
    auth.uid(),
    (SELECT email FROM auth.users WHERE id = auth.uid()),
    'DELETE_LOCATION',
    'location',
    OLD.id::TEXT,
    jsonb_build_object(
      'code', OLD.code,
      'city', OLD.city,
      'deleted_at', NOW()
    ),
    NOW()
  );
  RETURN OLD;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_location_delete ON locations;
CREATE TRIGGER on_location_delete
  BEFORE DELETE ON locations
  FOR EACH ROW EXECUTE FUNCTION log_location_deletion();

-- 包裹删除审计
CREATE OR REPLACE FUNCTION log_package_deletion()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO operation_logs (
    user_id,
    user_email,
    action,
    target_type,
    target_id,
    details,
    created_at
  )
  VALUES (
    auth.uid(),
    (SELECT email FROM auth.users WHERE id = auth.uid()),
    'DELETE_PACKAGE',
    'package',
    OLD.id::TEXT,
    jsonb_build_object(
      'package_number', OLD.package_number,
      'location', OLD.location,
      'city', OLD.city,
      'deleted_at', NOW()
    ),
    NOW()
  );
  RETURN OLD;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_package_delete ON packages;
CREATE TRIGGER on_package_delete
  BEFORE DELETE ON packages
  FOR EACH ROW EXECUTE FUNCTION log_package_deletion();
```

#### 查看删除记录

```sql
-- 查看最近的库位删除记录
SELECT 
  user_email,
  details->>'code' as deleted_location,
  details->>'city' as city,
  created_at
FROM operation_logs
WHERE action = 'DELETE_LOCATION'
ORDER BY created_at DESC;

-- 查看最近的包裹删除记录
SELECT 
  user_email,
  details->>'package_number' as package_number,
  details->>'location' as location,
  created_at
FROM operation_logs
WHERE action = 'DELETE_PACKAGE'
ORDER BY created_at DESC
LIMIT 50;
```

---

### 2. 定期数据备份

#### 方法 A：Supabase Dashboard 导出

1. 进入 **Table Editor**
2. 选择表（locations / packages）
3. 点击右上角 **...** → **Download as CSV**
4. 保存到本地

**建议频率：** 每周一次

#### 方法 B：前端导出功能

1. 进入 **中心退件管理** 页面
2. 点击 **导出数据** 按钮
3. 自动下载 JSON 文件

**优点：** 包含完整的包裹信息，可用于恢复

#### 方法 C：SQL 备份（高级）

```bash
# 使用 pg_dump 导出整个数据库
pg_dump -h db.xxxxx.supabase.co \
        -U postgres \
        -d postgres \
        -F c \
        -f backup_$(date +%Y%m%d).dump
```

---

### 3. 限制删除权限

**当前策略：** Admin 和 Super Admin 可以删除

**更严格的策略：** 只允许 Super Admin 删除

```sql
-- 更新 locations 表的删除策略
DROP POLICY IF EXISTS "管理员可以删除授权城市的库位" ON locations;

CREATE POLICY "只有super_admin可以删除库位"
  ON locations FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'super_admin'
    )
  );

-- 更新 packages 表的删除策略
DROP POLICY IF EXISTS "管理员可以删除授权城市的包裹" ON packages;

CREATE POLICY "只有super_admin可以删除包裹"
  ON packages FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'super_admin'
    )
  );
```

---

### 4. 增强前端确认流程

**当前流程：** 单次确认  
**建议改进：** 需要输入库位号确认

修改 `src/pages/LocationManagement.jsx`：

```javascript
const handleDeleteLocation = async (id) => {
  const location = locations.find(l => l.id === id);
  if (!location) return;
  
  // 第一次确认
  const confirmed = window.confirm(
    `⚠️ 警告：删除操作无法恢复！\n\n` +
    `库位号：${location.code}\n` +
    `包含包裹：${packageCount} 件\n\n` +
    `确认要删除吗？`
  );
  
  if (!confirmed) return;
  
  // 第二次确认：要求输入库位号
  const input = prompt(`请输入库位号 "${location.code}" 以确认删除：`);
  
  if (input !== location.code) {
    alert('❌ 库位号不匹配，取消删除');
    return;
  }
  
  // 执行删除
  // ... 原有的删除逻辑
};
```

---

## 📊 监控与追踪

### 查看系统使用情况

```sql
-- 统计各城市的数据量
SELECT 
  city,
  COUNT(DISTINCT location) as total_locations,
  COUNT(*) as total_packages
FROM packages
GROUP BY city;

-- 查看今天的操作记录
SELECT 
  user_email,
  action,
  COUNT(*) as operation_count
FROM operation_logs
WHERE created_at >= CURRENT_DATE
GROUP BY user_email, action
ORDER BY operation_count DESC;

-- 查看数据增长趋势
SELECT 
  DATE(created_at) as date,
  COUNT(*) as new_packages
FROM packages
WHERE created_at >= CURRENT_DATE - INTERVAL '7 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

---

## 🆘 常见问题 FAQ

### Q1：为什么数据会丢失？

**A：** Supabase **不会**自动删除数据。可能原因：
1. 管理员手动删除
2. 前端代码触发删除（通过 deleteLocation 或 deletePackage 函数）
3. SQL 脚本误操作

### Q2：恢复数据后，包裹数据也会恢复吗？

**A：** 不会。库位删除时，关联的包裹会被级联删除。  
需要从备份中恢复包裹数据。

### Q3：如何查看谁删除了数据？

**A：** 安装审计日志触发器后，执行：

```sql
SELECT 
  user_email,
  action,
  details,
  created_at
FROM operation_logs
WHERE action LIKE '%DELETE%'
ORDER BY created_at DESC;
```

### Q4：免费版 Supabase 有数据保留限制吗？

**A：** 
- ✅ 免费版有**存储限制**（500MB 数据库）
- ❌ 但**不会自动删除**旧数据
- ⚠️ 达到限制后会阻止新数据写入

### Q5：如何防止误删除？

**A：** 
1. ✅ 限制删除权限（只允许 Super Admin）
2. ✅ 启用删除审计日志
3. ✅ 增强前端确认流程
4. ✅ 定期备份数据

---

## 📞 需要帮助？

如果以上方案都无法解决问题，请提供以下信息：

1. **诊断脚本输出结果**（截图或文本）
2. **Supabase 项目 ID**
3. **登录用户邮箱**
4. **问题发生时间**
5. **最后一次看到数据的时间**

联系方式：
- 📧 Email: neo4444l.zhang@gmail.com
- 📖 文档: [GitHub](https://github.com/yourusername/yourrepo)

---

## 📝 文件清单

本次为您创建的文件：

| 文件路径 | 说明 |
|---------|------|
| `database/数据丢失诊断.sql` | 全面诊断脚本 |
| `database/恢复丢失的库位.sql` | 数据恢复 + 审计日志 |
| `docs/数据丢失问题-解决方案.md` | 详细说明（本文档） |
| `docs/快速修复-数据丢失.md` | 5分钟快速修复指南 |
| `docs/数据丢失-完整方案.md` | 完整方案总结 |

README 已更新，新增：
- 数据丢失问题 FAQ
- 数据安全与备份章节

---

**创建时间：** 2025-10-29  
**版本：** 1.0  
**适用于：** 退回包裹管理系统 v2.0+


