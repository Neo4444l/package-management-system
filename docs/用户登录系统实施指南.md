# 🔐 用户登录系统实施指南

## 📌 问题说明

**当前状态：**
- ❌ 任何人访问网址都能直接使用系统
- ❌ 无法区分不同用户
- ❌ 无法控制权限

**目标状态：**
- ✅ 用户需要账号密码登录
- ✅ 每个用户有自己的账号
- ✅ 可以设置不同权限
- ✅ 所有数据云端存储，多人共享

---

## 🚀 方案选择

### 方案A：Supabase（推荐）⭐⭐⭐

**优点：**
- ✅ 完全免费
- ✅ 内置用户认证系统
- ✅ 无需编写后端代码
- ✅ 支持邮箱/密码登录
- ✅ 自动管理用户数据
- ✅ 包含数据库功能

**费用：** 免费（每月500MB数据库，足够使用）

---

## 📋 完整实施步骤

### 第一步：创建Supabase项目（5分钟）

#### 1.1 注册Supabase

1. 访问：https://supabase.com
2. 点击 **"Start your project"**
3. 使用GitHub账号登录（最方便）

#### 1.2 创建项目

1. 点击 **"New Project"**
2. 填写信息：
   - **Name**: `package-management`
   - **Database Password**: 设置一个强密码（请记住！）
   - **Region**: 选择 **Southeast Asia (Singapore)**
3. 点击 **"Create new project"**
4. 等待2-3分钟初始化

---

### 第二步：配置用户认证（2分钟）

#### 2.1 启用邮箱认证

1. 在Supabase控制台，点击左侧 **"Authentication"**
2. 点击 **"Providers"**
3. 确认 **"Email"** 已启用 ✅（默认启用）

#### 2.2 配置邮件模板（可选）

在 **"Email Templates"** 中可以自定义：
- 注册确认邮件
- 密码重置邮件
- 邮件内容的语言

---

### 第三步：创建数据库表（10分钟）

#### 3.1 创建packages表

```sql
-- 在Supabase SQL Editor中执行
CREATE TABLE packages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users NOT NULL,
  package_number TEXT NOT NULL,
  location TEXT NOT NULL,
  package_status TEXT NOT NULL DEFAULT 'in-warehouse',
  customer_service TEXT,
  shelving_time TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  unshelving_time TIMESTAMPTZ,
  instruction_time TIMESTAMPTZ,
  status_history JSONB NOT NULL DEFAULT '[]'::jsonb,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 启用行级安全
ALTER TABLE packages ENABLE ROW LEVEL SECURITY;

-- 策略：用户只能看到所有包裹（共享数据）
CREATE POLICY "所有登录用户可查看包裹"
  ON packages FOR SELECT
  USING (auth.role() = 'authenticated');

-- 策略：所有登录用户可以添加包裹
CREATE POLICY "所有登录用户可添加包裹"
  ON packages FOR INSERT
  WITH CHECK (auth.role() = 'authenticated');

-- 策略：所有登录用户可以更新包裹
CREATE POLICY "所有登录用户可更新包裹"
  ON packages FOR UPDATE
  USING (auth.role() = 'authenticated');

-- 策略：所有登录用户可以删除包裹
CREATE POLICY "所有登录用户可删除包裹"
  ON packages FOR DELETE
  USING (auth.role() = 'authenticated');
```

#### 3.2 创建locations表

```sql
CREATE TABLE locations (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  code TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

ALTER TABLE locations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "所有登录用户可查看库位"
  ON locations FOR SELECT
  USING (auth.role() = 'authenticated');

CREATE POLICY "所有登录用户可添加库位"
  ON locations FOR INSERT
  WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "所有登录用户可删除库位"
  ON locations FOR DELETE
  USING (auth.role() = 'authenticated');
```

---

### 第四步：修改前端代码（30分钟）

#### 4.1 安装Supabase客户端

在项目文件夹中运行：
```bash
npm install @supabase/supabase-js
```

#### 4.2 创建Supabase配置文件

创建 `src/supabaseClient.js`:

```javascript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

#### 4.3 创建环境变量文件

在项目根目录创建 `.env`:

```env
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

**获取这两个值：**
1. 在Supabase控制台，点击 **"Settings"** → **"API"**
2. 复制 **"Project URL"** → 粘贴到 `VITE_SUPABASE_URL`
3. 复制 **"anon public"** key → 粘贴到 `VITE_SUPABASE_ANON_KEY`

#### 4.4 更新.gitignore

确保 `.gitignore` 包含：
```
.env
.env.local
```

#### 4.5 创建登录组件

创建 `src/components/Login.jsx`:

```javascript
import { useState } from 'react'
import { supabase } from '../supabaseClient'
import './Login.css'

export default function Login({ onLogin }) {
  const [loading, setLoading] = useState(false)
  const [isSignUp, setIsSignUp] = useState(false)
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')

  const handleLogin = async (e) => {
    e.preventDefault()
    setLoading(true)
    setError('')

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      })

      if (error) throw error
      onLogin(data.user)
    } catch (error) {
      setError(error.message)
    } finally {
      setLoading(false)
    }
  }

  const handleSignUp = async (e) => {
    e.preventDefault()
    setLoading(true)
    setError('')

    try {
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
      })

      if (error) throw error
      alert('注册成功！请检查您的邮箱进行验证。')
      setIsSignUp(false)
    } catch (error) {
      setError(error.message)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="login-container">
      <div className="login-box">
        <h1>📦 退回包裹管理系统</h1>
        <h2>{isSignUp ? '注册账号' : '登录'}</h2>
        
        <form onSubmit={isSignUp ? handleSignUp : handleLogin}>
          <div className="form-group">
            <label>邮箱</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="请输入邮箱"
              required
            />
          </div>

          <div className="form-group">
            <label>密码</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="请输入密码（至少6位）"
              required
              minLength={6}
            />
          </div>

          {error && <div className="error-message">{error}</div>}

          <button type="submit" disabled={loading} className="btn-primary">
            {loading ? '处理中...' : isSignUp ? '注册' : '登录'}
          </button>
        </form>

        <div className="toggle-mode">
          {isSignUp ? (
            <p>
              已有账号？
              <button onClick={() => setIsSignUp(false)}>立即登录</button>
            </p>
          ) : (
            <p>
              还没有账号？
              <button onClick={() => setIsSignUp(true)}>立即注册</button>
            </p>
          )}
        </div>
      </div>
    </div>
  )
}
```

#### 4.6 创建登录样式

创建 `src/components/Login.css`:

```css
.login-container {
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
}

.login-box {
  background: white;
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  width: 100%;
  max-width: 400px;
}

.login-box h1 {
  text-align: center;
  color: #667eea;
  margin-bottom: 10px;
  font-size: 2em;
}

.login-box h2 {
  text-align: center;
  color: #333;
  margin-bottom: 30px;
  font-size: 1.5em;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #555;
  font-weight: 500;
}

.form-group input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px;
  transition: border-color 0.3s;
}

.form-group input:focus {
  outline: none;
  border-color: #667eea;
}

.error-message {
  background: #fee;
  color: #c33;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 15px;
  text-align: center;
}

.btn-primary {
  width: 100%;
  padding: 14px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.toggle-mode {
  margin-top: 20px;
  text-align: center;
}

.toggle-mode p {
  color: #666;
}

.toggle-mode button {
  background: none;
  border: none;
  color: #667eea;
  text-decoration: underline;
  cursor: pointer;
  font-size: 16px;
  margin-left: 5px;
}

.toggle-mode button:hover {
  color: #764ba2;
}
```

#### 4.7 修改App.jsx

```javascript
import { useState, useEffect } from 'react'
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom'
import { supabase } from './supabaseClient'
import Login from './components/Login'
import HomePage from './pages/HomePage'
import ShelvingPage from './pages/ShelvingPage'
import ShelvingInput from './pages/ShelvingInput'
import UnshelvingPage from './pages/UnshelvingPage'
import ReturnDashboard from './pages/ReturnDashboard'
import LocationManagement from './pages/LocationManagement'
import CenterReturnManagement from './pages/CenterReturnManagement'
import './App.css'

function App() {
  const [session, setSession] = useState(null)
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    // 检查当前session
    supabase.auth.getSession().then(({ data: { session } }) => {
      setSession(session)
      setLoading(false)
    })

    // 监听认证状态变化
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((_event, session) => {
      setSession(session)
    })

    return () => subscription.unsubscribe()
  }, [])

  const handleLogout = async () => {
    await supabase.auth.signOut()
  }

  if (loading) {
    return (
      <div style={{ 
        display: 'flex', 
        justifyContent: 'center', 
        alignItems: 'center', 
        height: '100vh' 
      }}>
        加载中...
      </div>
    )
  }

  if (!session) {
    return <Login onLogin={setSession} />
  }

  return (
    <Router>
      <div className="app">
        <div className="user-info">
          <span>👤 {session.user.email}</span>
          <button onClick={handleLogout} className="btn-logout">
            退出登录
          </button>
        </div>
        
        <Routes>
          <Route path="/" element={<HomePage />} />
          <Route path="/shelving" element={<ShelvingPage />} />
          <Route path="/shelving-input" element={<ShelvingInput />} />
          <Route path="/unshelving" element={<UnshelvingPage />} />
          <Route path="/return-dashboard" element={<ReturnDashboard />} />
          <Route path="/location-management" element={<LocationManagement />} />
          <Route path="/center-return-management" element={<CenterReturnManagement />} />
        </Routes>
      </div>
    </Router>
  )
}

export default App
```

#### 4.8 添加用户信息样式到App.css

在 `src/App.css` 中添加：

```css
.user-info {
  position: fixed;
  top: 20px;
  right: 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  background: white;
  padding: 10px 20px;
  border-radius: 25px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}

.user-info span {
  color: #555;
  font-weight: 500;
}

.btn-logout {
  padding: 8px 16px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 15px;
  cursor: pointer;
  font-size: 14px;
  transition: transform 0.2s;
}

.btn-logout:hover {
  transform: translateY(-2px);
}
```

---

### 第五步：配置Vercel环境变量（5分钟）

#### 5.1 在Vercel添加环境变量

1. 访问 Vercel 控制台：https://vercel.com
2. 选择您的项目
3. 点击 **"Settings"** → **"Environment Variables"**
4. 添加两个变量：
   - **Name**: `VITE_SUPABASE_URL`  
     **Value**: 您的Supabase URL
   - **Name**: `VITE_SUPABASE_ANON_KEY`  
     **Value**: 您的Supabase Anon Key
5. 点击 **"Save"**

#### 5.2 重新部署

```bash
git add .
git commit -m "添加用户登录功能"
git push
```

Vercel会自动重新部署！

---

## 🎯 测试用户登录

### 第一个用户注册

1. 访问您的网站
2. 点击"立即注册"
3. 输入邮箱和密码（至少6位）
4. 点击"注册"
5. 检查邮箱，点击验证链接
6. 返回网站登录

### 添加更多用户

让团队成员：
1. 访问网站
2. 点击"立即注册"
3. 使用自己的邮箱注册
4. 验证邮箱后登录

---

## 👥 用户管理

### 在Supabase查看所有用户

1. Supabase控制台
2. **"Authentication"** → **"Users"**
3. 查看所有注册用户

### 手动添加用户

1. 在 **"Users"** 页面点击 **"Add user"**
2. 输入邮箱
3. 设置临时密码
4. 发送邀请邮件

### 删除用户

1. 在用户列表中找到用户
2. 点击右侧菜单
3. 选择 **"Delete user"**

---

## 🔐 进阶：权限管理

### 添加角色系统

如果您需要管理员、普通用户等不同角色：

#### 1. 创建profiles表

```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  email TEXT,
  role TEXT NOT NULL DEFAULT 'user',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "用户可以查看自己的资料"
  ON profiles FOR SELECT
  USING (auth.uid() = id);

-- 自动创建profile
CREATE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, email, role)
  VALUES (new.id, new.email, 'user');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

#### 2. 修改packages表策略

根据角色限制权限：

```sql
-- 示例：只有管理员可以删除
CREATE POLICY "只有管理员可以删除包裹"
  ON packages FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );
```

---

## 📱 功能特性

实施后您将拥有：

✅ **用户注册和登录**
- 邮箱 + 密码认证
- 邮箱验证
- 密码重置功能

✅ **数据共享**
- 所有登录用户共享数据
- 实时数据同步

✅ **安全性**
- 未登录无法访问
- 行级安全策略
- 密码加密存储

✅ **用户管理**
- 查看所有用户
- 手动添加/删除用户
- 可扩展角色权限

---

## 💰 费用说明

**Supabase 免费版：**
- ✅ 500MB数据库
- ✅ 无限用户认证
- ✅ 5GB文件存储
- ✅ 社区支持

对于中小团队完全够用！

---

## 🆚 对比：升级前后

| 功能 | 升级前 | 升级后 |
|------|--------|--------|
| 访问控制 | ❌ 任何人可访问 | ✅ 需要登录 |
| 数据存储 | LocalStorage | Supabase云端 |
| 多人协作 | ❌ 不支持 | ✅ 支持 |
| 数据共享 | ❌ 各自独立 | ✅ 实时共享 |
| 用户管理 | ❌ 无 | ✅ 完整管理 |
| 权限控制 | ❌ 无 | ✅ 可配置 |

---

## 📞 获取帮助

- **Supabase文档**: https://supabase.com/docs/guides/auth
- **React认证教程**: https://supabase.com/docs/guides/auth/auth-helpers/auth-ui-react

---

## 🎉 完成！

现在您的系统有了：
- ✅ 完整的用户登录系统
- ✅ 云端数据存储
- ✅ 多人实时协作
- ✅ 安全的权限控制

**享受您的专业退回包裹管理系统吧！** 🚀

