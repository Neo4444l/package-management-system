# 🚨 立即操作 - 修复城市切换死循环

## ✅ 代码已修复完成！

已更新的文件：
1. ✅ `src/contexts/CityContext.jsx` - 添加超时保护和错误恢复
2. ✅ `src/components/UserManagement.jsx` - 修复城市选项引用
3. ✅ `src/components/CitySelector.jsx` - 已确认无问题

---

## 🎯 立即执行（5分钟完成）

### 第 1 步：清除浏览器缓存 ⏱️ 30秒

**Windows:**
```
1. 按 Ctrl + Shift + Delete
2. 选择"所有时间"
3. 勾选所有项
4. 点击"清除数据"
```

**Mac:**
```
1. 按 Cmd + Shift + Delete
2. 选择"所有时间"
3. 勾选所有项
4. 点击"清除数据"
```

**或者在浏览器控制台执行：**
```javascript
// 按 F12 打开控制台，粘贴并回车：
localStorage.clear()
sessionStorage.clear()
document.cookie.split(";").forEach(c => {
  document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
})
location.reload()
```

---

### 第 2 步：修复数据库 ⏱️ 2分钟

访问：https://supabase.com → 你的项目 → SQL Editor

**复制并执行以下完整脚本：**

```sql
-- ==================== 紧急修复脚本 ====================

-- 1. 检查当前状态
SELECT 
  '=== 用户城市权限检查 ===' AS info,
  COUNT(*) AS total_users,
  COUNT(*) FILTER (WHERE cities IS NULL OR array_length(cities, 1) IS NULL) AS users_without_cities,
  COUNT(*) FILTER (WHERE role = 'super_admin') AS super_admins
FROM profiles;

-- 2. 修复所有用户的城市数据
DO $$
DECLARE
  fixed_count INTEGER := 0;
BEGIN
  -- Super Admin：所有城市
  UPDATE profiles
  SET 
    cities = ARRAY['MIA', 'WPB', 'FTM', 'MCO', 'TPA'],
    current_city = COALESCE(current_city, 'MIA')
  WHERE role = 'super_admin';
  
  GET DIAGNOSTICS fixed_count = ROW_COUNT;
  RAISE NOTICE 'Super Admin 修复: % 人', fixed_count;

  -- 其他用户：如果城市为空，给 MIA
  UPDATE profiles
  SET 
    cities = ARRAY['MIA'],
    current_city = 'MIA'
  WHERE (cities IS NULL OR array_length(cities, 1) IS NULL)
    AND role != 'super_admin';
  
  GET DIAGNOSTICS fixed_count = ROW_COUNT;
  RAISE NOTICE '普通用户修复: % 人', fixed_count;

  -- 修复 current_city 不在 cities 中的情况
  UPDATE profiles
  SET current_city = cities[1]
  WHERE current_city IS NULL 
    OR NOT (current_city = ANY(cities));
  
  GET DIAGNOSTICS fixed_count = ROW_COUNT;
  RAISE NOTICE 'Current city 修复: % 人', fixed_count;
END $$;

-- 3. 修复包裹和库位
UPDATE packages SET city = 'MIA' WHERE city IS NULL;
UPDATE locations SET city = 'MIA' WHERE city IS NULL;

-- 4. 验证结果
SELECT 
  role,
  COUNT(*) AS count,
  array_agg(DISTINCT current_city) AS cities_in_use
FROM profiles
GROUP BY role
ORDER BY 
  CASE role
    WHEN 'super_admin' THEN 1
    WHEN 'admin' THEN 2
    WHEN 'manager' THEN 3
    ELSE 4
  END;

-- 5. 最终检查
SELECT 
  CASE 
    WHEN COUNT(*) FILTER (WHERE cities IS NULL OR array_length(cities, 1) IS NULL) = 0 
    THEN '✅ 所有用户都有城市权限'
    ELSE '⚠️ 仍有用户缺少城市权限'
  END AS status
FROM profiles;
```

**期望输出：**
```
✅ 所有用户都有城市权限
```

---

### 第 3 步：提交代码并部署 ⏱️ 2分钟

**在项目目录执行：**

```bash
# 查看修改的文件
git status

# 添加所有更改
git add src/contexts/CityContext.jsx
git add src/components/UserManagement.jsx

# 提交
git commit -m "fix: 修复城市切换死循环和超时问题

- 添加查询和更新超时保护（5s/3s）
- 修复 super_admin 城市权限判断逻辑
- 添加错误恢复机制（自动回退）
- 修复 UserManagement 城市选项引用"

# 推送到远程（触发 Vercel 自动部署）
git push origin main
```

---

### 第 4 步：等待部署完成 ⏱️ 2-3分钟

**检查部署状态：**

1. 访问：https://vercel.com/dashboard
2. 找到你的项目
3. 查看 Deployments 页面
4. 等待最新部署变成 ✅ 绿色

**或者在终端查看：**
```bash
# 如果安装了 Vercel CLI
vercel logs
```

---

## 🧪 测试验证

部署完成后，按顺序测试：

### ✅ 测试 1：登录
```
1. 清除浏览器缓存（再次确认）
2. 重新访问网站
3. 登录账号
4. ✓ 应该正常进入首页，不卡住
```

### ✅ 测试 2：城市切换
```
1. 点击顶部城市选择器（🏙️ 迈阿密 ▼）
2. 选择其他城市（如 WPB）
3. ✓ 应该在 3 秒内完成切换
4. ✓ 页面自动刷新
5. ✓ 显示新城市名称
```

### ✅ 测试 3：用户管理（如果是 Super Admin）
```
1. 点击"用户管理"
2. ✓ 应该正常加载，不卡住
3. ✓ 看到"城市权限"列
4. 点击"分配城市"
5. ✓ Modal 正常打开
6. 选择城市并保存
7. ✓ 保存成功，不卡住
```

### ✅ 测试 4：数据隔离
```
1. 在 MIA 城市添加一个包裹
2. 切换到 WPB 城市
3. ✓ 应该看不到 MIA 的包裹
4. 切换回 MIA
5. ✓ 包裹仍然存在
```

---

## 🐛 如果仍然出问题

### 检查 1：浏览器控制台
```
F12 → Console
```
查找：
- ❌ 红色错误
- "查询超时" 或 "更新超时"

### 检查 2：网络请求
```
F12 → Network
```
查找：
- ⏳ Pending 超过 10 秒的请求
- 请求的 URL 中是否有 `profiles`

### 检查 3：数据库
在 Supabase SQL Editor 执行：
```sql
SELECT id, email, role, cities, current_city 
FROM profiles
WHERE auth.uid() = id;
```
确认：
- ✅ `cities` 不为空
- ✅ `current_city` 在 `cities` 数组中

---

## 🔄 紧急回滚（如果需要）

如果新代码有问题，立即回滚：

```bash
# 回退到上一次提交
git revert HEAD

# 推送回滚
git push origin main
```

---

## 📊 修复原理

### 问题根因
1. **无超时机制** → 查询卡住时无法恢复
2. **逻辑错误** → Super Admin 城市判断失败
3. **无错误恢复** → 失败后状态混乱

### 修复方案
```javascript
// 添加超时保护
const timeout = new Promise((_, reject) => 
  setTimeout(() => reject(new Error('查询超时')), 5000)
)
await Promise.race([queryPromise, timeout])

// 修复逻辑
let accessibleCities = cities
if (role === 'super_admin') {
  accessibleCities = ALL_CITIES // 所有城市
}

// 错误恢复
try {
  setCurrentCity(newCity) // 乐观更新
  await updateDB()
} catch (error) {
  setCurrentCity(previousCity) // 回退
  alert('切换失败')
}
```

---

## ✨ 完成后的效果

1. ✅ 城市切换 < 3 秒完成
2. ✅ 超时自动提示并回退
3. ✅ Super Admin 可访问所有城市
4. ✅ 用户管理正常打开
5. ✅ 数据完全隔离
6. ✅ 不再出现 Loading 死循环

---

## 📞 需要帮助？

如果执行过程中遇到任何问题，请告诉我：

1. **哪一步卡住了？**（1/2/3/4）
2. **浏览器控制台的错误信息**（F12 → Console 截图）
3. **Vercel 部署日志**（如果部署失败）

**现在就开始执行第 1 步！** 🚀

