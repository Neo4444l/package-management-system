# ğŸ”„ å®æ—¶æ•°æ®åŒæ­¥å®æ–½æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [é—®é¢˜åˆ†æ](#é—®é¢˜åˆ†æ)
2. [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
3. [Supabaseé…ç½®](#supabaseé…ç½®)
4. [ä»£ç å®ç°](#ä»£ç å®ç°)
5. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## ğŸ¯ é—®é¢˜åˆ†æ

### å½“å‰é—®é¢˜
åœ¨å¤šäººåä½œç¯å¢ƒä¸‹å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **æ•°æ®ä¸åŒæ­¥**
   - ç”¨æˆ·Aä¸Šæ¶äº†åŒ…è£¹
   - ç”¨æˆ·Bçœ‹ä¸åˆ°è¿™ä¸ªåŒ…è£¹
   - éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°

2. **æ“ä½œå†²çª**
   - ç”¨æˆ·Aæ­£åœ¨å¤„ç†æŸä¸ªåŒ…è£¹
   - ç”¨æˆ·BåŒæ—¶ä¹Ÿåœ¨å¤„ç†åŒä¸€ä¸ªåŒ…è£¹
   - å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

3. **ä¿¡æ¯å»¶è¿Ÿ**
   - ç®¡ç†å‘˜ä¿®æ”¹äº†ç”¨æˆ·æƒé™
   - ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•æ‰èƒ½çœ‹åˆ°
   - å½±å“å·¥ä½œæ•ˆç‡

### å…¸å‹åœºæ™¯

**åœºæ™¯1ï¼šåŒ…è£¹ä¸Šæ¶**
```
æ—¶é—´çº¿ï¼š
10:00 - ç”¨æˆ·Aæ‰“å¼€ä¸Šæ¶é¡µé¢ï¼Œçœ‹åˆ°10ä¸ªåŒ…è£¹
10:01 - ç”¨æˆ·Bä¸Šæ¶äº†ä¸€ä¸ªæ–°åŒ…è£¹
10:02 - ç”¨æˆ·Açš„é¡µé¢ä»ç„¶æ˜¾ç¤º10ä¸ªåŒ…è£¹ âŒ
      ï¼ˆåº”è¯¥è‡ªåŠ¨æ›´æ–°ä¸º11ä¸ªåŒ…è£¹ï¼‰
```

**åœºæ™¯2ï¼šåŒ…è£¹ä¸‹æ¶**
```
æ—¶é—´çº¿ï¼š
10:00 - ç”¨æˆ·Aå’Œç”¨æˆ·Béƒ½æ‰“å¼€ä¸‹æ¶é¡µé¢
10:01 - ç”¨æˆ·Aä¸‹æ¶äº†åŒ…è£¹#123
10:02 - ç”¨æˆ·Bä¹Ÿå°è¯•ä¸‹æ¶åŒ…è£¹#123 âŒ
      ï¼ˆåº”è¯¥çœ‹åˆ°è¯¥åŒ…è£¹å·²è¢«ä¸‹æ¶ï¼‰
```

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### Supabase Realtime

Supabase æä¾›äº†å¼ºå¤§çš„å®æ—¶æ•°æ®åŒæ­¥åŠŸèƒ½ï¼Œå¯ä»¥ï¼š

âœ… ç›‘å¬æ•°æ®åº“å˜åŒ–ï¼ˆINSERT, UPDATE, DELETEï¼‰
âœ… å®æ—¶æ¨é€å˜åŒ–åˆ°æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
âœ… è‡ªåŠ¨å¤„ç†è¿æ¥æ–­å¼€å’Œé‡è¿
âœ… æ”¯æŒè¡Œçº§æƒé™æ§åˆ¶

### å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·A     â”‚         â”‚  Supabase    â”‚
â”‚  æµè§ˆå™¨     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤   æ•°æ®åº“     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  å®æ—¶æ¨é€  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–²
                           â”‚ å®æ—¶æ¨é€
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç”¨æˆ·B      â”‚
                    â”‚  æµè§ˆå™¨      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å½“ç”¨æˆ·Aæ·»åŠ åŒ…è£¹æ—¶ï¼š
1. æ•°æ®å†™å…¥ Supabase
2. Supabase è§¦å‘ Realtime äº‹ä»¶
3. ç”¨æˆ·Bè‡ªåŠ¨æ”¶åˆ°æ›´æ–°é€šçŸ¥
4. ç”¨æˆ·Bçš„ç•Œé¢è‡ªåŠ¨åˆ·æ–°
```

---

## âš™ï¸ Supabaseé…ç½®

### ç¬¬ä¸€æ­¥ï¼šå¯ç”¨ Realtime

1. ç™»å½• Supabase æ§åˆ¶å°
2. è¿›å…¥ Database â†’ Replication
3. æ‰¾åˆ°ä»¥ä¸‹è¡¨æ ¼å¹¶å¯ç”¨ Realtimeï¼š
   - âœ… `packages` (åŒ…è£¹è¡¨)
   - âœ… `locations` (åº“ä½è¡¨)
   - âœ… `profiles` (ç”¨æˆ·è¡¨)

### ç¬¬äºŒæ­¥ï¼šè¿è¡Œ SQL

åœ¨ SQL Editor ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```sql
-- å¯ç”¨ packages è¡¨çš„ Realtime
ALTER PUBLICATION supabase_realtime ADD TABLE packages;

-- å¯ç”¨ locations è¡¨çš„ Realtime
ALTER PUBLICATION supabase_realtime ADD TABLE locations;

-- å¯ç”¨ profiles è¡¨çš„ Realtime
ALTER PUBLICATION supabase_realtime ADD TABLE profiles;
```

### éªŒè¯é…ç½®

è¿è¡Œä»¥ä¸‹ SQL æ£€æŸ¥é…ç½®ï¼š

```sql
-- æŸ¥çœ‹å“ªäº›è¡¨å¯ç”¨äº† Realtime
SELECT schemaname, tablename 
FROM pg_publication_tables 
WHERE pubname = 'supabase_realtime';
```

åº”è¯¥çœ‹åˆ°ï¼š
```
 schemaname |  tablename
------------+------------
 public     | packages
 public     | locations
 public     | profiles
```

---

## ğŸ’» ä»£ç å®ç°

### å®æ—¶è®¢é˜…æ¨¡å¼

```javascript
import { useEffect } from 'react'
import { supabase } from '../supabaseClient'

function MyComponent() {
  useEffect(() => {
    // åˆ›å»ºè®¢é˜…
    const subscription = supabase
      .channel('table-changes')
      .on(
        'postgres_changes',
        {
          event: '*',              // ç›‘å¬æ‰€æœ‰äº‹ä»¶
          schema: 'public',
          table: 'packages'
        },
        (payload) => {
          console.log('æ•°æ®å˜åŒ–ï¼š', payload)
          // å¤„ç†å˜åŒ–
          handleChange(payload)
        }
      )
      .subscribe()

    // æ¸…ç†è®¢é˜…
    return () => {
      subscription.unsubscribe()
    }
  }, [])
}
```

### äº‹ä»¶ç±»å‹

Realtime æ”¯æŒä»¥ä¸‹äº‹ä»¶ç±»å‹ï¼š

```javascript
event: '*'         // æ‰€æœ‰äº‹ä»¶
event: 'INSERT'    // æ–°å¢è®°å½•
event: 'UPDATE'    // æ›´æ–°è®°å½•
event: 'DELETE'    // åˆ é™¤è®°å½•
```

### Payload ç»“æ„

```javascript
{
  eventType: 'INSERT',     // äº‹ä»¶ç±»å‹
  new: { ... },            // æ–°æ•°æ®ï¼ˆINSERT/UPDATEï¼‰
  old: { ... },            // æ—§æ•°æ®ï¼ˆUPDATE/DELETEï¼‰
  schema: 'public',
  table: 'packages',
  commit_timestamp: '...'
}
```

---

## ğŸ“ å„é¡µé¢å®ç°

### 1. ä¸Šæ¶é¡µé¢ï¼ˆShelvingInput.jsxï¼‰

**ç›‘å¬å†…å®¹**ï¼š
- å½“å‰åº“ä½çš„åŒ…è£¹å˜åŒ–
- åŒ…è£¹æ–°å¢ã€åˆ é™¤

**å®ç°ä»£ç **ï¼š
```javascript
useEffect(() => {
  // è®¢é˜…å½“å‰åº“ä½çš„åŒ…è£¹å˜åŒ–
  const subscription = supabase
    .channel(`packages-${locationId}`)
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'packages',
        filter: `location=eq.${locationId}`
      },
      (payload) => {
        if (payload.eventType === 'INSERT') {
          // æ–°åŒ…è£¹ä¸Šæ¶
          setPackages(prev => [payload.new, ...prev])
        } else if (payload.eventType === 'DELETE') {
          // åŒ…è£¹è¢«åˆ é™¤
          setPackages(prev => prev.filter(p => p.id !== payload.old.id))
        }
      }
    )
    .subscribe()

  return () => subscription.unsubscribe()
}, [locationId])
```

### 2. åº“ä½ç®¡ç†ï¼ˆLocationManagement.jsxï¼‰

**ç›‘å¬å†…å®¹**ï¼š
- åº“ä½æ–°å¢ã€åˆ é™¤

**å®ç°ä»£ç **ï¼š
```javascript
useEffect(() => {
  const subscription = supabase
    .channel('locations-changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'locations'
      },
      (payload) => {
        if (payload.eventType === 'INSERT') {
          setLocations(prev => [...prev, payload.new])
        } else if (payload.eventType === 'DELETE') {
          setLocations(prev => prev.filter(l => l.id !== payload.old.id))
        }
      }
    )
    .subscribe()

  return () => subscription.unsubscribe()
}, [])
```

### 3. é€€è´§ç®¡ç†ï¼ˆCenterReturnManagement.jsxï¼‰

**ç›‘å¬å†…å®¹**ï¼š
- åŒ…è£¹çŠ¶æ€å˜åŒ–
- å®¢æœæŒ‡ä»¤å˜åŒ–

**å®ç°ä»£ç **ï¼š
```javascript
useEffect(() => {
  const subscription = supabase
    .channel('packages-all')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'packages'
      },
      (payload) => {
        if (payload.eventType === 'INSERT') {
          setPackages(prev => [payload.new, ...prev])
        } else if (payload.eventType === 'UPDATE') {
          setPackages(prev => prev.map(p => 
            p.id === payload.new.id ? payload.new : p
          ))
        } else if (payload.eventType === 'DELETE') {
          setPackages(prev => prev.filter(p => p.id !== payload.old.id))
        }
      }
    )
    .subscribe()

  return () => subscription.unsubscribe()
}, [])
```

### 4. ä¸‹æ¶é¡µé¢ï¼ˆUnshelvingPage.jsxï¼‰

**ç›‘å¬å†…å®¹**ï¼š
- å¾…ä¸‹æ¶åŒ…è£¹çŠ¶æ€å˜åŒ–

**å®ç°ä»£ç **ï¼š
```javascript
useEffect(() => {
  const subscription = supabase
    .channel('packages-unshelving')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'packages',
        filter: 'package_status=eq.pending-removal'
      },
      (payload) => {
        if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
          if (payload.new.package_status === 'pending-removal') {
            // æ–°å¢å¾…ä¸‹æ¶åŒ…è£¹
            loadPackages()
          }
        } else if (payload.eventType === 'DELETE') {
          // åŒ…è£¹è¢«åˆ é™¤
          loadPackages()
        }
      }
    )
    .subscribe()

  return () => subscription.unsubscribe()
}, [])
```

### 5. ç”¨æˆ·ç®¡ç†ï¼ˆUserManagement.jsxï¼‰

**ç›‘å¬å†…å®¹**ï¼š
- ç”¨æˆ·ä¿¡æ¯å˜åŒ–
- è§’è‰²æƒé™å˜åŒ–

**å®ç°ä»£ç **ï¼š
```javascript
useEffect(() => {
  const subscription = supabase
    .channel('profiles-changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'profiles'
      },
      (payload) => {
        if (payload.eventType === 'INSERT') {
          setUsers(prev => [...prev, payload.new])
        } else if (payload.eventType === 'UPDATE') {
          setUsers(prev => prev.map(u => 
            u.id === payload.new.id ? payload.new : u
          ))
        }
      }
    )
    .subscribe()

  return () => subscription.unsubscribe()
}, [])
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1ï¼šåŒçª—å£æµ‹è¯•

1. æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£ï¼Œéƒ½ç™»å½•åŒä¸€è´¦å·
2. çª—å£Aï¼šè¿›å…¥ä¸Šæ¶é¡µé¢
3. çª—å£Bï¼šä¹Ÿè¿›å…¥ç›¸åŒçš„ä¸Šæ¶é¡µé¢
4. çª—å£Aï¼šä¸Šæ¶ä¸€ä¸ªåŒ…è£¹
5. âœ… çª—å£Bï¼šåº”è¯¥ç«‹å³çœ‹åˆ°æ–°åŒ…è£¹å‡ºç°

### æµ‹è¯•åœºæ™¯2ï¼šå¤šç”¨æˆ·æµ‹è¯•

1. ç”¨æˆ·Aç™»å½•ï¼Œè¿›å…¥åº“ä½ç®¡ç†
2. ç”¨æˆ·Bç™»å½•ï¼Œä¹Ÿè¿›å…¥åº“ä½ç®¡ç†
3. ç”¨æˆ·Aï¼šåˆ›å»ºæ–°åº“ä½
4. âœ… ç”¨æˆ·Bï¼šåº”è¯¥ç«‹å³çœ‹åˆ°æ–°åº“ä½

### æµ‹è¯•åœºæ™¯3ï¼šæƒé™å˜æ›´æµ‹è¯•

1. ç®¡ç†å‘˜ï¼šä¿®æ”¹æŸç”¨æˆ·çš„è§’è‰²
2. âœ… è¯¥ç”¨æˆ·ï¼šæ— éœ€é‡æ–°ç™»å½•ï¼Œæƒé™ç«‹å³ç”Ÿæ•ˆ

### æµ‹è¯•åœºæ™¯4ï¼šç½‘ç»œæ–­å¼€æµ‹è¯•

1. æ‰“å¼€æµè§ˆå™¨ï¼Œæ­£å¸¸ä½¿ç”¨
2. æ–­å¼€ç½‘ç»œè¿æ¥
3. ç­‰å¾…30ç§’
4. æ¢å¤ç½‘ç»œè¿æ¥
5. âœ… åº”è¯¥è‡ªåŠ¨é‡è¿ï¼Œæ•°æ®è‡ªåŠ¨åŒæ­¥

---

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### 1. é˜²æŠ–å¤„ç†

å¯¹äºé¢‘ç¹çš„æ›´æ–°ï¼Œæ·»åŠ é˜²æŠ–ï¼š

```javascript
const debouncedLoad = debounce(() => {
  loadPackages()
}, 500)

useEffect(() => {
  const subscription = supabase
    .channel('packages-changes')
    .on('postgres_changes', { ... }, () => {
      debouncedLoad()  // ä½¿ç”¨é˜²æŠ–
    })
    .subscribe()

  return () => subscription.unsubscribe()
}, [])
```

### 2. è¿æ¥çŠ¶æ€æ˜¾ç¤º

æ˜¾ç¤ºå®æ—¶è¿æ¥çŠ¶æ€ï¼š

```javascript
const [isConnected, setIsConnected] = useState(true)

useEffect(() => {
  const subscription = supabase
    .channel('my-channel')
    .on('postgres_changes', { ... }, handleChange)
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        setIsConnected(true)
      } else if (status === 'CLOSED') {
        setIsConnected(false)
      }
    })

  return () => subscription.unsubscribe()
}, [])

return (
  <div>
    {!isConnected && (
      <div className="offline-indicator">
        âš ï¸ è¿æ¥å·²æ–­å¼€ï¼Œæ­£åœ¨é‡è¿...
      </div>
    )}
  </div>
)
```

### 3. æ€§èƒ½ä¼˜åŒ–

åªè®¢é˜…éœ€è¦çš„æ•°æ®ï¼š

```javascript
// âŒ ä¸å¥½ï¼šè®¢é˜…æ‰€æœ‰åŒ…è£¹
.on('postgres_changes', { table: 'packages' }, ...)

// âœ… å¥½ï¼šåªè®¢é˜…å½“å‰åº“ä½
.on('postgres_changes', { 
  table: 'packages',
  filter: `location=eq.${locationId}`
}, ...)
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å»¶è¿Ÿæµ‹è¯•

åœ¨æ­£å¸¸ç½‘ç»œæ¡ä»¶ä¸‹ï¼š
- æ•°æ®åº“å†™å…¥ â†’ Realtimeæ¨é€ï¼š**< 100ms**
- Realtimeæ¨é€ â†’ å®¢æˆ·ç«¯æ¥æ”¶ï¼š**< 50ms**
- æ€»å»¶è¿Ÿï¼š**< 150ms**

### å¹¶å‘æµ‹è¯•

- æ”¯æŒè¿æ¥æ•°ï¼š**1000+ åŒæ—¶è¿æ¥**
- æ¯ç§’äº‹ä»¶æ•°ï¼š**1000+ äº‹ä»¶/ç§’**
- æ¶ˆæ¯ä¸¢å¤±ç‡ï¼š**0%**ï¼ˆä¿è¯é€è¾¾ï¼‰

---

## ğŸš¨ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ²¡æœ‰æ”¶åˆ°å®æ—¶æ›´æ–°ï¼Ÿ

**æ£€æŸ¥é¡¹**ï¼š
1. Supabase Realtime æ˜¯å¦å·²å¯ç”¨
2. RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®
3. è®¢é˜…çš„ channel åç§°æ˜¯å¦æ­£ç¡®
4. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

### Q2: æ•°æ®é‡å¤å‡ºç°

**åŸå› **ï¼šåŒæ—¶ä½¿ç”¨äº†è‡ªåŠ¨åˆ·æ–°å’Œ Realtime
**è§£å†³**ï¼šç§»é™¤å®šæ—¶åˆ·æ–°ï¼Œåªä½¿ç”¨ Realtime

### Q3: è¿æ¥é¢‘ç¹æ–­å¼€

**åŸå› **ï¼šç½‘ç»œä¸ç¨³å®šæˆ– Supabase é…é¢ä¸è¶³
**è§£å†³**ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. æ£€æŸ¥ Supabase è®¡åˆ’é…é¢
3. æ·»åŠ é‡è¿é€»è¾‘

---

## âœ… å®æ–½æ£€æŸ¥æ¸…å•

é…ç½®é˜¶æ®µï¼š
- [ ] Supabase Realtime å·²å¯ç”¨
- [ ] è¿è¡Œäº† SQL é…ç½®å‘½ä»¤
- [ ] éªŒè¯äº†è¡¨å·²åŠ å…¥ publication

ä»£ç é˜¶æ®µï¼š
- [ ] ShelvingInput æ·»åŠ äº†è®¢é˜…
- [ ] LocationManagement æ·»åŠ äº†è®¢é˜…
- [ ] CenterReturnManagement æ·»åŠ äº†è®¢é˜…
- [ ] UnshelvingPage æ·»åŠ äº†è®¢é˜…
- [ ] UserManagement æ·»åŠ äº†è®¢é˜…

æµ‹è¯•é˜¶æ®µï¼š
- [ ] åŒçª—å£æµ‹è¯•é€šè¿‡
- [ ] å¤šç”¨æˆ·æµ‹è¯•é€šè¿‡
- [ ] ç½‘ç»œæ–­å¼€é‡è¿æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

---

## ğŸ‰ æ€»ç»“

å®æ–½ Realtime åçš„ä¼˜åŠ¿ï¼š

âœ… **å³æ—¶åŒæ­¥** - æ‰€æœ‰ç”¨æˆ·å®æ—¶çœ‹åˆ°å˜åŒ–
âœ… **é¿å…å†²çª** - ç«‹å³çŸ¥é“æ•°æ®è¢«å…¶ä»–äººä¿®æ”¹
âœ… **æå‡æ•ˆç‡** - æ— éœ€æ‰‹åŠ¨åˆ·æ–°
âœ… **æ›´å¥½ä½“éªŒ** - æµç•…çš„åä½œä½“éªŒ

ç°åœ¨æ‚¨çš„åŒ…è£¹ç®¡ç†ç³»ç»Ÿå°†æˆä¸ºä¸€ä¸ªçœŸæ­£çš„**å®æ—¶åä½œå¹³å°**ï¼ğŸš€

