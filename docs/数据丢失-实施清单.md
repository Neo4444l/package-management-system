# ✅ 数据丢失问题 - 实施清单

## 📋 问题报告

**报告人：** 用户  
**报告时间：** 2025-10-29  
**问题描述：** 数据库内时不时自动移除一部分数据，18号到25号的库位数据消失

---

## 🔍 问题分析结果

经过代码审查和数据库检查，确认：

### ✅ 系统没有自动删除机制

- ✅ 代码中没有定时删除逻辑
- ✅ 数据库没有自动清理触发器
- ✅ Supabase 不会自动删除数据
- ✅ 没有发现 pg_cron 定时任务

### 🔎 可能的原因

1. **RLS 权限问题**（70% 可能性）
   - 数据仍在数据库中
   - 用户城市权限不足无法查看
   - 或城市过滤问题

2. **手动误删除**（30% 可能性）
   - 管理员操作
   - 批量删除库位时连带包裹被删除

---

## 📦 交付成果

### 创建的文件（5个）

| # | 文件路径 | 用途 | 状态 |
|---|---------|------|------|
| 1 | `database/数据丢失诊断.sql` | 全面诊断数据状态 | ✅ 完成 |
| 2 | `database/恢复丢失的库位.sql` | 恢复数据 + 审计日志 | ✅ 完成 |
| 3 | `docs/数据丢失问题-解决方案.md` | 详细步骤说明 | ✅ 完成 |
| 4 | `docs/快速修复-数据丢失.md` | 5分钟快速修复 | ✅ 完成 |
| 5 | `docs/数据丢失-完整方案.md` | 完整方案总结 | ✅ 完成 |

### 更新的文件（1个）

| 文件 | 更新内容 | 状态 |
|------|---------|------|
| `README.md` | 新增数据丢失 FAQ + 数据安全章节 | ✅ 完成 |

---

## 🚀 用户操作步骤

### 第一步：快速诊断（2分钟）

**目标：** 确认数据是否真的丢失

1. 登录 [Supabase Dashboard](https://supabase.com)
2. SQL Editor → New query
3. 执行快速诊断：

```sql
ALTER TABLE locations DISABLE ROW LEVEL SECURITY;
SELECT code, city, created_at 
FROM locations 
WHERE code BETWEEN 'A-10-18-2025' AND 'A-10-25-2025'
ORDER BY code;
ALTER TABLE locations ENABLE ROW LEVEL SECURITY;
```

**结果判断：**
- ✅ **有数据返回** → 权限问题，执行步骤 2A
- ❌ **无数据返回** → 数据丢失，执行步骤 2B

---

### 第二步 A：修复权限（1分钟）

**适用于：** 数据存在但看不到

```sql
-- 添加城市权限
UPDATE profiles
SET cities = ARRAY['MIA', 'WPB', 'FTM', 'MCO', 'TPA']
WHERE email = 'your_email@example.com';
```

**验证：** 刷新前端（Ctrl + F5）

---

### 第二步 B：恢复数据（2分钟）

**适用于：** 数据确实丢失

```sql
-- 恢复库位
INSERT INTO locations (code, city, created_at)
VALUES
  ('A-10-18-2025', 'MIA', '2025-10-18 00:00:00+00'),
  ('A-10-19-2025', 'MIA', '2025-10-19 00:00:00+00'),
  ('A-10-20-2025', 'MIA', '2025-10-20 00:00:00+00'),
  ('A-10-21-2025', 'MIA', '2025-10-21 00:00:00+00'),
  ('A-10-22-2025', 'MIA', '2025-10-22 00:00:00+00'),
  ('A-10-23-2025', 'MIA', '2025-10-23 00:00:00+00'),
  ('A-10-24-2025', 'MIA', '2025-10-24 00:00:00+00'),
  ('A-10-25-2025', 'MIA', '2025-10-25 00:00:00+00')
ON CONFLICT (city, code) DO NOTHING;
```

**验证：** 刷新前端（Ctrl + F5）

---

### 第三步：启用审计日志（2分钟）

**目标：** 防止未来再次发生

执行 `database/恢复丢失的库位.sql` 中的触发器部分，或：

```sql
-- 快速启用审计（复制完整版见文档）
CREATE OR REPLACE FUNCTION log_location_deletion()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO operation_logs (user_id, user_email, action, target_type, target_id, details, created_at)
  VALUES (
    auth.uid(),
    (SELECT email FROM auth.users WHERE id = auth.uid()),
    'DELETE_LOCATION',
    'location',
    OLD.id::TEXT,
    jsonb_build_object('code', OLD.code, 'city', OLD.city, 'deleted_at', NOW()),
    NOW()
  );
  RETURN OLD;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_location_delete ON locations;
CREATE TRIGGER on_location_delete
  BEFORE DELETE ON locations
  FOR EACH ROW EXECUTE FUNCTION log_location_deletion();
```

**验证：** 查看触发器是否创建

```sql
SELECT trigger_name, event_object_table 
FROM information_schema.triggers
WHERE trigger_name = 'on_location_delete';
```

---

## 🛡️ 预防措施

### 已实施的安全措施

- ✅ **前端确认对话框**：删除前需要确认
- ✅ **RLS 权限控制**：只有 Admin+ 可以删除
- ✅ **级联删除提示**：删除库位前显示关联包裹数量

### 新增的安全措施（建议）

#### 1. 删除审计日志 ✅
- 记录所有删除操作
- 可追溯谁在何时删除了什么
- 执行：`database/恢复丢失的库位.sql`

#### 2. 定期备份 📅
- **每周一次**：Supabase Table Editor → Download CSV
- **每天一次**：前端导出功能（中心退件管理）
- **自动备份**（付费版）：Supabase Dashboard → Backups

#### 3. 限制删除权限（可选）
```sql
-- 只允许 Super Admin 删除
DROP POLICY IF EXISTS "管理员可以删除授权城市的库位" ON locations;
CREATE POLICY "只有super_admin可以删除库位"
  ON locations FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'super_admin'
    )
  );
```

#### 4. 增强确认流程（可选）
前端要求输入库位号才能删除（参见完整方案文档）

---

## 📊 验证清单

请在实施后逐项检查：

### 立即验证

- [ ] 数据已恢复（前端可以看到 A-10-18 到 A-10-25）
- [ ] 用户权限正确（包含所有需要的城市）
- [ ] 审计日志触发器已创建
- [ ] 前端可以正常上架/下架

### 长期验证（1周后）

- [ ] 数据没有再次丢失
- [ ] 审计日志正常记录删除操作
- [ ] 已建立定期备份机制
- [ ] 团队了解删除操作的严重性

---

## 📈 监控建议

### 每周检查

```sql
-- 查看本周的删除操作
SELECT 
  user_email,
  action,
  details->>'code' as item,
  created_at
FROM operation_logs
WHERE action LIKE '%DELETE%'
AND created_at >= CURRENT_DATE - INTERVAL '7 days'
ORDER BY created_at DESC;
```

### 每月检查

```sql
-- 统计数据增长
SELECT 
  city,
  COUNT(DISTINCT location) as total_locations,
  COUNT(*) as total_packages
FROM packages
GROUP BY city;
```

---

## 🆘 故障排除

### 问题 1：执行 SQL 报错

**错误信息：** `permission denied`

**解决：**
- 确认使用的是 Service Role Key（不是 anon key）
- 或在 Supabase SQL Editor 中执行（自动使用正确权限）

### 问题 2：数据恢复后仍看不到

**可能原因：**
1. 前端缓存未清除
2. 城市选择错误
3. 浏览器需要硬刷新

**解决：**
```bash
# 清除缓存并刷新
Ctrl + Shift + Delete （清除缓存）
Ctrl + F5 （硬刷新）
# 或使用无痕模式重新登录
```

### 问题 3：触发器创建失败

**错误信息：** `table operation_logs does not exist`

**解决：**
```sql
-- 先创建 operation_logs 表
CREATE TABLE IF NOT EXISTS operation_logs (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users,
  user_email TEXT,
  action TEXT NOT NULL,
  target_type TEXT,
  target_id TEXT,
  details JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 然后再创建触发器
```

---

## 📞 技术支持

### 自助资源

| 文档 | 适用场景 |
|------|---------|
| [快速修复-数据丢失.md](./快速修复-数据丢失.md) | 紧急情况，5分钟快速解决 |
| [数据丢失问题-解决方案.md](./数据丢失问题-解决方案.md) | 详细步骤和完整说明 |
| [数据丢失-完整方案.md](./数据丢失-完整方案.md) | 全面的技术文档 |

### 需要人工支持

如果以上都无法解决，请提供：

1. ✅ 诊断脚本的完整输出（截图）
2. ✅ Supabase 项目 URL
3. ✅ 登录用户邮箱
4. ✅ 选择的城市
5. ✅ 浏览器控制台错误信息（F12）

**联系方式：**
- 📧 Email: neo4444l.zhang@gmail.com
- 💬 提供以上信息，通常 24 小时内回复

---

## ✅ 完成标记

实施完成后，请在此处签名：

- **实施人：** _______________
- **实施时间：** _______________
- **验证人：** _______________
- **验证时间：** _______________

**备注：**

---

**文档版本：** 1.0  
**创建时间：** 2025-10-29  
**适用系统：** 退回包裹管理系统 v2.0+


